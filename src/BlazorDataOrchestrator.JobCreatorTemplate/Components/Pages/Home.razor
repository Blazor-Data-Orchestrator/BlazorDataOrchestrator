@page "/"
@using Radzen
@using Radzen.Blazor
@using MonacoRazor
@using SimpleBlazorMonaco
@using System.IO
@using System.Text.Json
@using BlazorDataOrchestrator.Core
@using Microsoft.CodeAnalysis
@using Microsoft.CodeAnalysis.CSharp
@inject IWebHostEnvironment Environment
@inject IConfiguration Configuration
@inject DialogService DialogService

<PageTitle>Job Creator</PageTitle>

<RadzenCard class="rz-shadow-3" Style="padding: 0; margin: 16px; height: calc(100vh - 112px); border-radius: 16px; overflow: hidden; background: #ffffff;">
    <RadzenStack Gap="0" Style="height: 100%;">
        @* Header with Tabs *@
        <RadzenTabs TabPosition="TabPosition.Top" @bind-SelectedIndex="selectedTabIndex"
                    Style="flex-grow: 1; height: 100%;">
            <Tabs>
                <RadzenTabsItem Text="Code" Icon="code">
                    @* Main Content Area *@
                    <RadzenSplitter Orientation="Orientation.Horizontal" Style="height: calc(100vh - 180px);">
                        <RadzenSplitterPane Size="70%" Min="40%">
                            @* Editor Section *@
                            <RadzenStack Gap="0" Style="height: 100%; background: #fafafa; border-radius: 12px;">
                                @* Editor Toolbar *@
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                                             JustifyContent="JustifyContent.Start" Gap="12"
                                             Style="padding: 12px 20px; background: #ffffff; border-bottom: 1px solid #e8e8e8; border-radius: 12px 12px 0 0;">
                                    <RadzenDropDown @bind-Value="selectedLanguage" Data="@languageOptions"
                                                    TextProperty="Name" ValueProperty="Value"
                                                    Style="background: #ffffff; color: #333; border: 1px solid #ddd; border-radius: 8px; min-width: 100px;"
                                                    Change="@OnLanguageChanged"
                                                    AllowClear="false" />
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="4">
                                        <RadzenDropDown @bind-Value="selectedFile" Data="@fileList"
                                                        Style="background: #ffffff; color: #333; border: 1px solid #ddd; border-radius: 8px; min-width: 150px;"
                                                        Change="@OnFileChanged"
                                                        AllowClear="false" />
                                    </RadzenStack>
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="8" Style="margin-left: auto;">
                                        <RadzenButton Icon="save" Text="Save" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" title="Save file" Click="@OnSaveFile" IsBusy="@isSaving" />
                                        <RadzenSplitButton Click="@OnRunCode" Text="Run" Icon="play_arrow"
                                                           ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small">
                                            <ChildContent>
                                                <RadzenSplitButtonItem Text="Run Code [Development]" Value="Development" Icon="play_arrow" />
                                                <RadzenSplitButtonItem Text="Run Code [Production]" Value="Production" Icon="rocket_launch" />
                                            </ChildContent>
                                        </RadzenSplitButton>
                                        <RadzenButton Text="Create NuGet" Icon="inventory_2"
                                                      ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small"
                                                      Click="@OnCreatePackage" />
                                    </RadzenStack>
                                </RadzenStack>

                                @* Code Editor *@
                                <div style="flex-grow: 1; height: calc(100% - 50px); overflow: hidden; margin: 12px; border-radius: 8px; border: 1px solid #e8e8e8;">
                                    <CodeEditor @ref="codeEditor"
                                                Language="@GetMonacoLanguage()"
                                                Code="@currentCode"
                                                Height="100%"
                                                Width="100%"
                                                Border="0"
                                                Margin="0" />
                                </div>
                            </RadzenStack>
                        </RadzenSplitterPane>

                        <RadzenSplitterPane Size="30%" Min="20%">
                            @* Chat Section *@
                            <RadzenStack Gap="0" Style="height: 100%; background: #f8f9fa; border-left: 1px solid #e8e8e8;">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                                             Style="padding: 14px 20px; background: #ffffff; border-bottom: 1px solid #e8e8e8;">
                                    <RadzenText TextStyle="TextStyle.Subtitle1" Style="color: #333; margin: 0; font-weight: 600;">
                                        <RadzenIcon Icon="chat" Style="vertical-align: middle; margin-right: 8px; color: #5c6bc0;" />Chat
                                    </RadzenText>
                                </RadzenStack>
                                <div style="flex-grow: 1; overflow: hidden; padding: 12px;">
                                    <RadzenAIChat @ref="aiChat"
                                                  Style="height: 100%; --rz-aichat-background-color: #ffffff; --rz-text-color: #333; border-radius: 12px;"
                                                  ShowClearButton="true" />
                                </div>
                            </RadzenStack>
                        </RadzenSplitterPane>
                    </RadzenSplitter>
                </RadzenTabsItem>
                <RadzenTabsItem Text="Logs" Icon="list_alt">
                    <RadzenStack Gap="8" Style="height: calc(100vh - 180px); padding: 12px;">
                        @* Log Controls *@
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="12" Style="padding: 8px 12px; background: #ffffff; border-radius: 8px; border: 1px solid #e8e8e8;">
                            <RadzenText TextStyle="TextStyle.Body2" Style="color: #666;">
                                Job ID: <strong>@currentJobId</strong> | Instance ID: <strong>@currentJobInstanceId</strong>
                            </RadzenText>
                            <RadzenButton Text="Refresh Logs" Icon="refresh" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@OnRefreshLogs" Style="margin-left: auto;" />
                        </RadzenStack>
                        @* Log Output *@
                        <RadzenCard Style="flex-grow: 1; background: #f8f9fa; color: #333; overflow: auto; padding: 12px; font-family: 'Consolas', 'Monaco', monospace; border-radius: 8px;">
                            @if (jobLogs.Any())
                            {
                                <RadzenDataList Data="@jobLogs" Style="background: transparent;">
                                    <Template Context="log">
                                        <div style="padding: 8px 12px; margin-bottom: 4px; background: #ffffff; border-radius: 6px; border-left: 4px solid @GetLogLevelColor(log.Level);">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start" Gap="8">
                                                <RadzenBadge BadgeStyle="@GetLogLevelBadgeStyle(log.Level)" Text="@log.Level" Style="min-width: 60px; text-align: center;" />
                                                <RadzenStack Gap="2" Style="flex-grow: 1;">
                                                    <RadzenText TextStyle="TextStyle.Caption" Style="color: #888;">@log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</RadzenText>
                                                    <RadzenText TextStyle="TextStyle.Body2" Style="color: #333; word-break: break-word;">@log.Details</RadzenText>
                                                </RadzenStack>
                                            </RadzenStack>
                                        </div>
                                    </Template>
                                </RadzenDataList>
                            }
                            else
                            {
                                <pre style="margin: 0; white-space: pre-wrap; background: #ffffff; padding: 16px; border-radius: 8px; border: 1px solid #e8e8e8;">@logOutput</pre>
                            }
                        </RadzenCard>
                    </RadzenStack>
                </RadzenTabsItem>
            </Tabs>
        </RadzenTabs>


    </RadzenStack>
</RadzenCard>

@code {
    private CodeEditor? codeEditor;
    private RadzenAIChat? aiChat;
    private int selectedTabIndex = 0;
    private string? selectedFile;
    private string selectedLanguage = "csharp";
    private string currentCode = "";
    private string logOutput = "Ready to execute...";
    private bool isSaving = false;

    private List<string> fileList = new List<string>();
    private List<JobLogEntry> jobLogs = new List<JobLogEntry>();
    private int currentJobId = 0;
    private int currentJobInstanceId = 0;
    private JobManager? jobManager;

    private List<LanguageOption> languageOptions = new List<LanguageOption>
    {
        new LanguageOption { Name = "C#", Value = "csharp" },
        new LanguageOption { Name = "Python", Value = "python" }
    };

    public class LanguageOption
    {
        public string Name { get; set; } = "";
        public string Value { get; set; } = "";
    }

    private string CodeFolderPath => Path.Combine(Environment.ContentRootPath, "Code");
    private string ConfigFilePath => Path.Combine(CodeFolderPath, "configuration.json");

    protected override async Task OnInitializedAsync()
    {
        if (!Directory.Exists(CodeFolderPath))
        {
            Directory.CreateDirectory(CodeFolderPath);
        }

        // Initialize JobManager if connection strings are available
        InitializeJobManager();

        // Load configuration and files
        LoadConfiguration();
        LoadFiles();

        if (fileList.Any())
        {
            selectedFile = fileList.First();
            // Load the content into currentCode but don't try to update the editor yet
            var path = Path.Combine(CodeFolderPath, selectedFile);
            if (File.Exists(path))
            {
                currentCode = await File.ReadAllTextAsync(path);
            }
        }
    }

    private void InitializeJobManager()
    {
        try
        {
            var sqlConnectionString = Configuration.GetConnectionString("blazororchestratordb") ?? "";
            var blobConnectionString = Configuration.GetConnectionString("blobs") ?? "";
            var queueConnectionString = Configuration.GetConnectionString("queues") ?? "";
            var tableConnectionString = Configuration.GetConnectionString("tables") ?? "";

            if (!string.IsNullOrEmpty(sqlConnectionString) && !string.IsNullOrEmpty(tableConnectionString))
            {
                jobManager = new JobManager(sqlConnectionString, blobConnectionString, queueConnectionString, tableConnectionString);
            }
        }
        catch (Exception ex)
        {
            logOutput += $"[{DateTime.Now:HH:mm:ss}] Warning: Could not initialize JobManager: {ex.Message}\n";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && codeEditor != null && !string.IsNullOrEmpty(currentCode))
        {
            await codeEditor.UpdateCodeAsync(currentCode);
            var lang = selectedFile != null ? GetLanguageFromFile(selectedFile) : GetMonacoLanguage();
            await codeEditor.UpdateLanguageAsync(lang);
        }
    }

    private void LoadConfiguration()
    {
        try
        {
            if (File.Exists(ConfigFilePath))
            {
                var json = File.ReadAllText(ConfigFilePath);
                var config = JsonSerializer.Deserialize<DesignerConfiguration>(json);
                if (config != null)
                {
                    if (!string.IsNullOrEmpty(config.SelectedLanguage))
                    {
                        selectedLanguage = config.SelectedLanguage;
                    }
                    currentJobId = config.LastJobId;
                    currentJobInstanceId = config.LastJobInstanceId;
                }
            }
            else
            {
                SaveConfiguration();
            }
        }
        catch (Exception ex)
        {
            logOutput += $"[{DateTime.Now:HH:mm:ss}] Error loading config: {ex.Message}\n";
        }
    }

    private void SaveConfiguration()
    {
        try
        {
            var config = new DesignerConfiguration 
            { 
                SelectedLanguage = selectedLanguage,
                LastJobId = currentJobId,
                LastJobInstanceId = currentJobInstanceId
            };
            var json = JsonSerializer.Serialize(config, new JsonSerializerOptions { WriteIndented = true });
            File.WriteAllText(ConfigFilePath, json);
        }
        catch (Exception ex)
        {
            logOutput += $"[{DateTime.Now:HH:mm:ss}] Error saving config: {ex.Message}\n";
        }
    }

    private void LoadFiles()
    {
        fileList.Clear();
        if (!Directory.Exists(CodeFolderPath)) return;

        var allFiles = Directory.GetFiles(CodeFolderPath);
        foreach (var file in allFiles)
        {
            var fileName = Path.GetFileName(file);
            if (fileName.Equals("configuration.json", StringComparison.OrdinalIgnoreCase)) continue;

            var ext = Path.GetExtension(fileName).ToLowerInvariant();
            bool include = false;

            if (selectedLanguage == "csharp")
            {
                if (ext == ".cs" || ext == ".json") include = true;
            }
            else if (selectedLanguage == "python")
            {
                if (ext == ".py" || ext == ".txt" || ext == ".json") include = true;
            }

            if (include)
            {
                fileList.Add(fileName);
            }
        }
    }

    private async Task LoadFileContent(string fileName)
    {
        try
        {
            var path = Path.Combine(CodeFolderPath, fileName);
            if (File.Exists(path))
            {
                currentCode = await File.ReadAllTextAsync(path);
                var lang = GetLanguageFromFile(fileName);
                if (codeEditor != null)
                {
                    await codeEditor.UpdateCodeAsync(currentCode);
                    await codeEditor.UpdateLanguageAsync(lang);
                }
            }
        }
        catch (Exception ex)
        {
            logOutput += $"[{DateTime.Now:HH:mm:ss}] Error loading file '{fileName}': {ex.Message}\n";
        }
    }    

    private string GetMonacoLanguage()
    {
        return selectedLanguage switch
        {
            "csharp" => "csharp",
            "python" => "python",
            _ => "csharp"
        };
    }

    private string GetLanguageFromFile(string fileName)
    {
        var extension = System.IO.Path.GetExtension(fileName).ToLowerInvariant();
        return extension switch
        {
            ".cs" => "csharp",
            ".py" => "python",
            ".json" => "json",
            ".js" => "javascript",
            ".ts" => "typescript",
            _ => "plaintext"
        };
    }

    private async Task OnFileChanged(object value)
    {
        if (value is string fileName)
        {
            selectedFile = fileName;
            await LoadFileContent(fileName);
        }
        StateHasChanged();
    }

    private async Task OnLanguageChanged(object value)
    {
        if (value is string lang)
        {
            selectedLanguage = lang;
            SaveConfiguration();
            LoadFiles();

            if (fileList.Any())
            {
                selectedFile = fileList.First();
                await LoadFileContent(selectedFile);
            }            
        }
        StateHasChanged();
    }

    private async Task OnRunCode(RadzenSplitButtonItem? item)
    {
        // Save before running
        if (!await OnSaveFile())
        {
            logOutput += $"[{DateTime.Now:HH:mm:ss}] Save failed. Aborting run.\n";
            return;
        }

        var environment = item?.Value?.ToString() ?? "Development";
        logOutput = $"[{DateTime.Now:HH:mm:ss}] Running code in {environment} mode...\n";

        if (codeEditor != null)
        {
            var currentCode = await codeEditor.GetCodeAsync();
            logOutput += $"[{DateTime.Now:HH:mm:ss}] Code retrieved ({currentCode?.Length ?? 0} characters)\n";

            // 1. Get AppSettings
            string appSettingsFileName = environment == "Production" ? "appsettingsProduction.json" : "appsettings.json";
            string appSettingsContent = "{}";
            string appSettingsFile = Path.Combine(Environment.ContentRootPath, appSettingsFileName);
            
            if (File.Exists(appSettingsFile))
            {
                appSettingsContent = await File.ReadAllTextAsync(appSettingsFile);
                logOutput += $"[{DateTime.Now:HH:mm:ss}] Loaded {appSettingsFileName}\n";
            }
            else
            {
                logOutput += $"[{DateTime.Now:HH:mm:ss}] Warning: {appSettingsFileName} not found.\n";
            }

            // 2. Create Job Instance
            int jobInstanceId = 0;
            if (jobManager != null)
            {
                try
                {
                    string jobName = System.Reflection.Assembly.GetEntryAssembly()?.GetName().Name ?? "DesignerJob";
                    jobInstanceId = await jobManager.CreateDesignerJobInstanceAsync(jobName);
                    currentJobInstanceId = jobInstanceId;
                    logOutput += $"[{DateTime.Now:HH:mm:ss}] Created Job Instance ID: {jobInstanceId}\n";
                }
                catch (Exception ex)
                {
                    logOutput += $"[{DateTime.Now:HH:mm:ss}] Error creating job instance: {ex.Message}\n";
                    return;
                }
            }
            else
            {
                 logOutput += $"[{DateTime.Now:HH:mm:ss}] Warning: JobManager not initialized. Skipping logging.\n";
            }

            // 3. Execute Code
            List<string> results = new List<string>();
            try
            {
                if (selectedLanguage == "csharp")
                {
                    logOutput += $"[{DateTime.Now:HH:mm:ss}] Executing ExecuteJob...\n";
                    results = await BlazorDataOrchestratorJob.ExecuteJob(appSettingsContent, -1, -1, currentJobInstanceId, -1);
                }
                else if (selectedLanguage == "python")
                {
                     logOutput += $"[{DateTime.Now:HH:mm:ss}] Python execution not fully implemented in Designer yet.\n";
                }

                logOutput += $"[{DateTime.Now:HH:mm:ss}] Execution complete.\n";

                // 4. Display Results
                if (results.Any())
                {
                    await DialogService.OpenAsync("Execution Results", ds =>
                        @<RadzenStack Gap="10">
                            <RadzenTextArea Value="@string.Join("\n", results)" Style="width: 100%; height: 300px;" ReadOnly="true" />
                            <RadzenButton Text="Close" Click="() => ds.Close(true)" Style="width: 100px; align-self: center;" />
                        </RadzenStack>
                    );
                }
            }
            catch (Exception ex)
            {
                logOutput += $"[{DateTime.Now:HH:mm:ss}] Error executing code: {ex.Message}\n";
                if (ex.InnerException != null)
                {
                    logOutput += $"[{DateTime.Now:HH:mm:ss}] Inner Error: {ex.InnerException.Message}\n";
                }
            }
        }

        StateHasChanged();
    }

    private void OnCreatePackage()
    {
        logOutput = $"[{DateTime.Now:HH:mm:ss}] Creating NuGet package...\n";
        logOutput += $"[{DateTime.Now:HH:mm:ss}] Package created successfully!\n";
        StateHasChanged();
    }

    private async Task<bool> OnSaveFile()
    {
        isSaving = true;
        StateHasChanged();

        try
        {
            if (codeEditor != null)
            {
                var code = await codeEditor.GetCodeAsync();
                if (!string.IsNullOrEmpty(selectedFile) && code != null)
                {
                    // Compilation check for main.cs
                    if (selectedFile.Equals("main.cs", StringComparison.OrdinalIgnoreCase))
                    {
                        try
                        {
                            var syntaxTree = CSharpSyntaxTree.ParseText(code);
                            var diagnostics = syntaxTree.GetDiagnostics();
                            var errors = diagnostics.Where(d => d.Severity == DiagnosticSeverity.Error).ToList();

                            if (errors.Any())
                            {
                                var errorMsg = string.Join("\n", errors.Select(e => $"Line {e.Location.GetLineSpan().StartLinePosition.Line + 1}: {e.GetMessage()}"));
                                logOutput = $"[{DateTime.Now:HH:mm:ss}] Compilation Failed:\n{errorMsg}\n";
                                
                                await DialogService.Alert($"Compilation Failed:\n{errorMsg}", "Save Error");
                                StateHasChanged();
                                return false;
                            }
                        }
                        catch (Exception ex)
                        {
                             logOutput = $"[{DateTime.Now:HH:mm:ss}] Error during compilation check: {ex.Message}\n";
                             StateHasChanged();
                             return false;
                        }
                    }

                    try 
                    {
                        var path = Path.Combine(CodeFolderPath, selectedFile);
                        await File.WriteAllTextAsync(path, code);
                        logOutput = $"[{DateTime.Now:HH:mm:ss}] File '{selectedFile}' saved successfully.\n";
                        StateHasChanged();
                        return true;
                    }
                    catch (Exception ex)
                    {
                        logOutput = $"[{DateTime.Now:HH:mm:ss}] Error saving file '{selectedFile}': {ex.Message}\n";
                        StateHasChanged();
                        return false;
                    }
                }
            }
            return false;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task OnRefreshLogs()
    {
        if (jobManager == null)
        {
            logOutput = $"[{DateTime.Now:HH:mm:ss}] JobManager not initialized. Check connection strings.\n";
            StateHasChanged();
            return;
        }

        try
        {
            // Try to resolve JobId from InstanceId if missing
            if (currentJobId == 0 && currentJobInstanceId > 0)
            {
                var jobId = await jobManager.GetJobIdFromInstanceIdAsync(currentJobInstanceId);
                if (jobId.HasValue)
                {
                    currentJobId = jobId.Value;
                }
            }

            if (currentJobId > 0)
            {
                // Get logs for the latest job instance of the current job
                if (currentJobInstanceId == 0)
                {
                    var latestInstanceId = await jobManager.GetLatestJobInstanceIdAsync(currentJobId);
                    if (latestInstanceId.HasValue)
                    {
                        currentJobInstanceId = latestInstanceId.Value;
                    }
                }

                if (currentJobInstanceId > 0)
                {
                    jobLogs = await jobManager.GetLogsForJobInstanceAsync(currentJobId, currentJobInstanceId);
                    logOutput = $"[{DateTime.Now:HH:mm:ss}] Loaded {jobLogs.Count} log entries for Job {currentJobId}, Instance {currentJobInstanceId}\n";
                }
                else
                {
                    logOutput = $"[{DateTime.Now:HH:mm:ss}] No job instances found for Job {currentJobId}\n";
                }
            }
            else
            {
                logOutput = $"[{DateTime.Now:HH:mm:ss}] No job selected. Run a job first to see logs.\n";
            }
        }
        catch (Exception ex)
        {
            logOutput = $"[{DateTime.Now:HH:mm:ss}] Error loading logs: {ex.Message}\n";
        }

        StateHasChanged();
    }

    private static string GetLogLevelColor(string level)
    {
        return level?.ToLower() switch
        {
            "error" => "#dc3545",
            "warning" => "#ffc107",
            "debug" => "#6c757d",
            _ => "#28a745" // Info
        };
    }

    private static BadgeStyle GetLogLevelBadgeStyle(string level)
    {
        return level?.ToLower() switch
        {
            "error" => BadgeStyle.Danger,
            "warning" => BadgeStyle.Warning,
            "debug" => BadgeStyle.Secondary,
            _ => BadgeStyle.Success // Info
        };
    }

    private class DesignerConfiguration
    {
        public string SelectedLanguage { get; set; } = "csharp";
        public int LastJobId { get; set; }
        public int LastJobInstanceId { get; set; }
    }
}
