@page "/"
@using BlazorApp1.Components.Pages
@using System.Threading.Tasks
@using System.Collections.Generic

<RadzenDialog />
<RadzenNotification />
<RadzenTooltip />
<RadzenContextMenu />

<div class="rz-p-4" style="min-height: 100vh; background-color: #f4f6f8;">
    <RadzenCard Class="rz-mb-4 rz-shadow-3">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
                <RadzenIcon Icon="build" IconColor="@Colors.Primary" />
                <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H1" Class="rz-m-0">
                    <strong>BlazorApp</strong> <span style="font-weight: 300;">Wizard</span>
                </RadzenText>
            </div>
            @if (Mode == "install")
            {
                <div class="d-flex align-items-center gap-3">
                    <RadzenText TextStyle="TextStyle.Body2" Class="rz-m-0">Step @CurrentStep of 4</RadzenText>
                    <RadzenProgressBar Value="@(CurrentStep * 25)" ShowValue="false" Style="width: 100px; height: 8px;" />
                </div>
            }
        </div>
    </RadzenCard>

    <div class="container" style="max-width: 1200px;">
        @if (Mode == "install")
        {
            <div class="row g-0">
                <div class="col-md-3 d-none d-md-block px-0">
                    <RadzenCard>
                        <div class="d-flex flex-column gap-2 mt-3">
                             @foreach (var s in Steps)
                             {
                                 <div class="@GetStepClass(s.Id)" style="padding: 10px; border-radius: 4px; transition: all 0.3s;">
                                     <RadzenIcon Icon="@(CurrentStep > s.Id ? "check_circle" : s.Icon)" Style="margin-right: 8px; vertical-align: middle;" />
                                     <span style="font-weight: 500;">@s.Label</span>
                                 </div>
                             }
                        </div>
                    </RadzenCard>
                </div>
                <div class="col-md-9 px-0">
                    <RadzenCard Class="rz-p-5 rz-shadow-5" Style="min-height: 500px; display: flex; flex-direction: column;">
                        <div style="flex: 1;">
                            <RadzenText TextStyle="TextStyle.H4" Class="rz-mb-4">@GetCurrentStepTitle()</RadzenText>
                            @if (CurrentStep == 1)
                            {
                                <StepAdmin Model="@Model" />
                            }
                            else if (CurrentStep == 2)
                            {
                                <StepDatabase Model="@Model" />
                            }
                            else if (CurrentStep == 3)
                            {
                                <StepStorage Model="@Model" />
                            }
                            else if (CurrentStep == 4)
                            {
                                <StepSummary Model="@Model" />
                            }
                        </div>
                        <div class="d-flex justify-content-between rz-mt-5 rz-pt-3" style="border-top: 1px solid #e0e0e0;">
                            <RadzenButton Variant="Variant.Text" Click="PrevStep" Text="Back" Disabled="@(CurrentStep == 1 || IsLoading)" ButtonStyle="ButtonStyle.Light" />
                            <RadzenButton Click="NextStep" Text="@(CurrentStep == 4 ? "Install System" : "Next Step")" Icon="@(CurrentStep == 4 ? "save" : "arrow_forward")" IsBusy="@IsLoading" BusyText="Processing..." ButtonStyle="@(CurrentStep == 4 ? ButtonStyle.Success : ButtonStyle.Primary)" />
                        </div>
                    </RadzenCard>
                </div>
            </div>
        }
        else
        {
            <UpgradeWorkflow />
        }
    </div>

    <div style="position: fixed; bottom: 20px; left: 20px; z-index: 1000;">
        <RadzenCard Class="rz-shadow-10" style="background-color: #343a40; color: white;">
            <RadzenText TextStyle="TextStyle.Caption" style="color: #adb5bd; text-transform: uppercase; font-weight: bold; border-bottom: 1px solid #495057; padding-bottom: 5px; margin-bottom: 10px;">Dev Simulation</RadzenText>
            <RadzenRadioButtonList @bind-Value="Mode" TValue="string" Orientation="Orientation.Vertical" Change="@(args => { if(Mode == "upgrade") ResetUpgrade(); })">
                <Items>
                    <RadzenRadioButtonListItem Text="New Install" Value="@("install")" Style="color: white;" />
                    <RadzenRadioButtonListItem Text="Upgrade Required" Value="@("upgrade")" Style="color: white;" />
                </Items>
            </RadzenRadioButtonList>
        </RadzenCard>
    </div>
</div>

@code {
    public string Mode { get; set; } = "install";
    public int CurrentStep { get; set; } = 1;
    public int StepIndex { get; set; } = 0; 
    public bool IsLoading { get; set; } = false;
    public InstallationModel Model { get; set; } = new InstallationModel();

    public class WizardStep { public int Id { get; set; } public string Label { get; set; } public string Icon { get; set; } }
    public List<WizardStep> Steps = new List<WizardStep> {
        new WizardStep { Id = 1, Label = "Admin Account", Icon = "account_circle" },
        new WizardStep { Id = 2, Label = "Database", Icon = "dns" },
        new WizardStep { Id = 3, Label = "Storage", Icon = "storage" },
        new WizardStep { Id = 4, Label = "Installation", Icon = "verified" }
    };

    private void ResetUpgrade() { }

    private string GetStepClass(int stepId)
    {
        if (CurrentStep == stepId) return "rz-background-color-primary-light rz-color-primary";
        if (CurrentStep > stepId) return "rz-color-success";
        return "rz-color-base-400";
    }

    private string GetCurrentStepTitle() => CurrentStep switch {
        1 => "Setup Administrator",
        2 => "Connect Database",
        3 => "Configure Storage",
        4 => "Summary",
        _ => string.Empty
    };

    private void OnStepChange(int index) { }

    private async Task NextStep()
    {
        IsLoading = true;
        await Task.Delay(500);
        if (CurrentStep < 4) { CurrentStep++; StepIndex++; }
        else { }
        IsLoading = false;
    }

    private void PrevStep()
    {
        if (CurrentStep > 1) { CurrentStep--; StepIndex--; }
    }
}
