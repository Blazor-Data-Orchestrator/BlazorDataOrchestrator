@page "/admin"
@using Radzen
@using Radzen.Blazor
@using BlazorOrchestrator.Web.Data.Data
@using BlazorOrchestrator.Web.Services
@using BlazorOrchestrator.Web.Components.Pages.Dialogs
@inject JobQueueService JobQueueService
@inject JobGroupService JobGroupService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject AppSettingsService AppSettingsService
@inject TimeDisplayService TimeDisplayService

<PageTitle>Administration</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
        <RadzenIcon Icon="admin_panel_settings" Style="font-size: 1.5rem;" />
        <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1" Style="margin: 0;">Administration</RadzenText>
    </RadzenStack>

    <RadzenTabs @bind-SelectedIndex="@SelectedTabIndex" Style="width: 100%;">
        <Tabs>
            <RadzenTabsItem Text="Manage Job Groups" Icon="folder_special">
                <RadzenStack Gap="1rem" Style="padding: 1.5rem 0;">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Job Group Configuration</RadzenText>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Text="Add Job Group" Icon="add" ButtonStyle="ButtonStyle.Success" Click="@OpenAddJobGroupDialog" />
                            <RadzenButton Text="Refresh" Icon="refresh" ButtonStyle="ButtonStyle.Light" Click="@LoadJobGroups" Disabled="@IsLoadingJobGroups" />
                        </RadzenStack>
                    </RadzenStack>

                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Style="margin-bottom: 1rem;">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                            Job Groups allow you to organize and categorize your jobs for easier management and filtering.
                        </RadzenText>
                    </RadzenAlert>

                    @if (IsLoadingJobGroups)
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 200px;">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                            <RadzenText TextStyle="TextStyle.Body1">Loading job groups...</RadzenText>
                        </RadzenStack>
                    }
                    else if (!JobGroups.Any())
                    {
                        <RadzenCard Style="padding: 2rem; text-align: center;">
                            <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                                <RadzenIcon Icon="folder_off" Style="font-size: 3rem; color: #9ca3af;" />
                                <RadzenText TextStyle="TextStyle.H6" Style="color: #6b7280; margin: 0;">No job groups configured</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="color: #9ca3af; margin: 0;">
                                    Create a job group to organize your jobs
                                </RadzenText>
                                <RadzenButton Text="Add Job Group" ButtonStyle="ButtonStyle.Primary" Click="@OpenAddJobGroupDialog" />
                            </RadzenStack>
                        </RadzenCard>
                    }
                    else
                    {
                        <RadzenDataGrid @ref="JobGroupGrid" Data="@JobGroups" TItem="JobGroup" 
                                        AllowPaging="true" PageSize="10" PagerHorizontalAlign="HorizontalAlign.Center"
                                        AllowSorting="true" Style="height: auto;">
                            <Columns>
                                <RadzenDataGridColumn TItem="JobGroup" Width="120px" Title="Actions">
                                    <Template Context="group">
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
                                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small"
                                                          Click="@(() => OpenEditJobGroupDialog(group))" />
                                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                                          Variant="Variant.Outlined" Click="@(() => DeleteJobGroup(group))" />
                                        </RadzenStack>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="JobGroup" Property="Id" Title="ID" Width="80px" />
                                <RadzenDataGridColumn TItem="JobGroup" Property="JobGroupName" Title="Group Name" />
                                <RadzenDataGridColumn TItem="JobGroup" Property="CreatedDate" Title="Created Date" Width="180px">
                                    <Template Context="group">
                                        @TimeDisplayService.FormatDateTime(group.CreatedDate)
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="JobGroup" Title="Jobs" Width="100px">
                                    <Template Context="group">
                                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@(group.JobJobGroups?.Count.ToString() ?? "0")" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    }
                </RadzenStack>
            </RadzenTabsItem>
            <RadzenTabsItem Text="Manage Job Queues" Icon="queue">
                <RadzenStack Gap="1rem" Style="padding: 1.5rem 0;">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Job Queue Configuration</RadzenText>
                        <RadzenButton Text="Add New Queue" Icon="add" ButtonStyle="ButtonStyle.Success" Click="@OpenAddQueueDialog" />
                    </RadzenStack>

                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Style="margin-bottom: 1rem;">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                            Job Queues allow you to route job execution to specific Azure Queues based on container size or other requirements. 
                            Jobs can be assigned to a specific queue in the Job Details page.
                        </RadzenText>
                    </RadzenAlert>

                    @if (IsLoading)
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 200px;">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                            <RadzenText TextStyle="TextStyle.Body1">Loading job queues...</RadzenText>
                        </RadzenStack>
                    }
                    else if (!JobQueues.Any())
                    {
                        <RadzenCard Style="padding: 2rem; text-align: center;">
                            <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                                <RadzenIcon Icon="queue" Style="font-size: 3rem; color: #9ca3af;" />
                                <RadzenText TextStyle="TextStyle.H6" Style="color: #6b7280; margin: 0;">No job queues configured</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="color: #9ca3af; margin: 0;">
                                    Create a job queue to route jobs to specific Azure Queues
                                </RadzenText>
                                <RadzenButton Text="Add New Queue" ButtonStyle="ButtonStyle.Primary" Click="@OpenAddQueueDialog" />
                            </RadzenStack>
                        </RadzenCard>
                    }
                    else
                    {
                        <RadzenDataGrid @ref="QueueGrid" Data="@JobQueues" TItem="JobQueue" 
                                        AllowPaging="true" PageSize="10" PagerHorizontalAlign="HorizontalAlign.Center"
                                        AllowSorting="true" Style="height: auto;">
                            <Columns>
                                <RadzenDataGridColumn TItem="JobQueue" Width="120px" Title="Actions">
                                    <Template Context="queue">
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
                                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small"
                                                          Click="@(() => OpenEditQueueDialog(queue))" />
                                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                                          Variant="Variant.Outlined" Click="@(() => DeleteQueue(queue))" />
                                        </RadzenStack>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="JobQueue" Property="Id" Title="ID" Width="80px" />
                                <RadzenDataGridColumn TItem="JobQueue" Property="QueueName" Title="Queue Name" />
                                <RadzenDataGridColumn TItem="JobQueue" Property="CreatedDate" Title="Created Date" Width="180px">
                                    <Template Context="queue">
                                        @TimeDisplayService.FormatDateTime(queue.CreatedDate)
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="JobQueue" Property="CreatedBy" Title="Created By" Width="150px" />
                                <RadzenDataGridColumn TItem="JobQueue" Title="Jobs Using" Width="100px">
                                    <Template Context="queue">
                                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@queue.Jobs.Count.ToString()" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    }
                </RadzenStack>
            </RadzenTabsItem>
            <RadzenTabsItem Text="Settings" Icon="settings">
                <RadzenStack Gap="1rem" Style="padding: 1.5rem 0;">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Application Settings</RadzenText>
                    </RadzenStack>

                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Style="margin-bottom: 1rem;">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                            Configure application-wide settings. The timezone setting affects how dates and times are displayed throughout the application.
                        </RadzenText>
                    </RadzenAlert>

                    <RadzenCard Style="padding: 1.5rem;">
                        <RadzenStack Gap="1.5rem">
                            <RadzenStack Gap="0.5rem">
                                <RadzenLabel Text="Display Timezone" Component="TimezoneOffset" Style="font-weight: 600;" />
                                <RadzenDropDown @bind-Value="@SelectedTimezoneOffset" 
                                                Data="@AvailableTimezones" 
                                                TextProperty="Label" 
                                                ValueProperty="Value"
                                                Style="width: 100%; max-width: 400px;" 
                                                Name="TimezoneOffset"
                                                Change="@OnTimezoneChanged" />
                                <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">
                                    Select the timezone for displaying dates and times in logs and other views.
                                </RadzenText>
                            </RadzenStack>

                            <RadzenStack Gap="0.5rem">
                                <RadzenLabel Text="Preview" Style="font-weight: 600;" />
                                <RadzenCard Style="background: #f8fafc; padding: 1rem;">
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="2rem" AlignItems="AlignItems.Center">
                                        <RadzenStack Gap="0.25rem">
                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">Current UTC Time</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Body1" Style="font-family: monospace;">@DateTime.UtcNow.ToString("g")</RadzenText>
                                        </RadzenStack>
                                        <RadzenIcon Icon="arrow_forward" Style="color: #6b7280;" />
                                        <RadzenStack Gap="0.25rem">
                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">Display Time (@SelectedTimezoneOffset)</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Body1" Style="font-family: monospace;">@TimeDisplayService.FormatCurrentTime()</RadzenText>
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Style="margin-top: 1rem;">
                                <RadzenButton Text="Save Settings" Icon="save" ButtonStyle="ButtonStyle.Success" 
                                              Click="@SaveSettings" Disabled="@IsSavingSettings" />
                                @if (IsSavingSettings)
                                {
                                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                                }
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenStack>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
</RadzenStack>

@code {
    private int SelectedTabIndex { get; set; } = 0;
    private bool IsLoading { get; set; } = true;
    private bool IsLoadingJobGroups { get; set; } = true;
    private List<JobQueue> JobQueues { get; set; } = new();
    private List<JobGroup> JobGroups { get; set; } = new();
    private RadzenDataGrid<JobQueue>? QueueGrid;
    private RadzenDataGrid<JobGroup>? JobGroupGrid;

    // Settings fields
    private string SelectedTimezoneOffset { get; set; } = "-08:00";
    private List<TimezoneOption> AvailableTimezones { get; set; } = new();
    private bool IsSavingSettings { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        // Load settings
        LoadSettings();
        
        // Run sequentially to avoid DbContext concurrency issues
        await LoadJobGroups();
        await LoadJobQueues();
    }

    #region Settings

    private void LoadSettings()
    {
        AvailableTimezones = AppSettingsService.GetAvailableTimezones();
        SelectedTimezoneOffset = AppSettingsService.GetTimezoneOffsetString();
    }

    private void OnTimezoneChanged()
    {
        // Trigger UI refresh to update the preview
        StateHasChanged();
    }

    private async Task SaveSettings()
    {
        IsSavingSettings = true;
        StateHasChanged();

        try
        {
            await AppSettingsService.SetTimezoneOffsetAsync(SelectedTimezoneOffset);
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Settings saved successfully. Please refresh the page for changes to take full effect.");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save settings: {ex.Message}");
        }
        finally
        {
            IsSavingSettings = false;
            StateHasChanged();
        }
    }

    #endregion

    #region Job Groups

    private async Task LoadJobGroups()
    {
        IsLoadingJobGroups = true;
        StateHasChanged();

        try
        {
            // Load all job groups with their job associations in a single query
            JobGroups = await JobGroupService.GetJobGroupsWithJobsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load job groups: {ex.Message}");
        }
        finally
        {
            IsLoadingJobGroups = false;
            StateHasChanged();
        }
    }

    private async Task OpenAddJobGroupDialog()
    {
        var result = await DialogService.OpenAsync<JobGroupDialog>("Add Job Group",
            new Dictionary<string, object>
            {
                { "OnSaved", EventCallback.Factory.Create<(string Name, bool IsActive)>(this, OnJobGroupCreated) },
                { "OnCancel", EventCallback.Factory.Create(this, () => DialogService.Close()) }
            },
            new DialogOptions { Width = "450px", CloseDialogOnEsc = true });
    }

    private async Task OpenEditJobGroupDialog(JobGroup group)
    {
        var result = await DialogService.OpenAsync<JobGroupDialog>("Edit Job Group",
            new Dictionary<string, object>
            {
                { "ExistingJobGroup", group },
                { "OnSaved", EventCallback.Factory.Create<(string Name, bool IsActive)>(this, async (data) => await OnJobGroupUpdated(group.Id, data)) },
                { "OnCancel", EventCallback.Factory.Create(this, () => DialogService.Close()) }
            },
            new DialogOptions { Width = "450px", CloseDialogOnEsc = true });
    }

    private async Task OnJobGroupCreated((string Name, bool IsActive) data)
    {
        try
        {
            var group = await JobGroupService.CreateJobGroupAsync(data.Name);

            DialogService.Close();
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"Job group '{data.Name}' created successfully.");
            await LoadJobGroups();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to create job group: {ex.Message}");
        }
    }

    private async Task OnJobGroupUpdated(int id, (string Name, bool IsActive) data)
    {
        try
        {
            var group = await JobGroupService.GetJobGroupByIdAsync(id);
            if (group != null)
            {
                group.JobGroupName = data.Name;
                await JobGroupService.UpdateJobGroupAsync(group);

                DialogService.Close();
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Job group '{data.Name}' updated successfully.");
                await LoadJobGroups();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to update job group: {ex.Message}");
        }
    }

    private async Task DeleteJobGroup(JobGroup group)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to delete the job group '{group.JobGroupName}'? This will remove all job associations with this group.",
            "Delete Job Group",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            try
            {
                await JobGroupService.DeleteJobGroupAsync(group.Id);
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Job group '{group.JobGroupName}' deleted successfully.");
                await LoadJobGroups();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to delete job group: {ex.Message}");
            }
        }
    }

    #endregion

    #region Job Queues

    private async Task LoadJobQueues()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            JobQueues = await JobQueueService.GetAllJobQueuesAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load job queues: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task OpenAddQueueDialog()
    {
        var newQueue = new JobQueue();
        await OpenQueueDialog(newQueue, "Add New Job Queue");
    }

    private async Task OpenEditQueueDialog(JobQueue queue)
    {
        await OpenQueueDialog(queue, $"Edit Job Queue - {queue.QueueName}");
    }

    private async Task OpenQueueDialog(JobQueue queue, string title)
    {
        var isNew = queue.Id == 0;
        var queueName = queue.QueueName ?? "";

        var result = await DialogService.OpenAsync(title, ds =>
            @<RadzenStack Gap="1.5rem" Style="min-width: 400px; padding: 1rem;">
                <RadzenStack Gap="0.5rem">
                    <RadzenLabel Text="Queue Name" Component="QueueName" Style="font-weight: 500;" />
                    <RadzenTextBox @bind-Value="@queueName" Name="QueueName" Style="width: 100%;" 
                                   Placeholder="e.g., jobs-large-container" />
                    <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">
                        This name will be used as the Azure Queue name. Use lowercase letters, numbers, and hyphens only.
                    </RadzenText>
                </RadzenStack>

                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => ds.Close(false))" />
                    <RadzenButton Text="@(isNew ? "Create" : "Save")" ButtonStyle="ButtonStyle.Primary" 
                                  Click="@(async () => {
                                      queue.QueueName = queueName;
                                      var success = await SaveQueue(queue);
                                      if (success) ds.Close(true);
                                  })" />
                </RadzenStack>
            </RadzenStack>,
        new DialogOptions { ShowTitle = true, CloseDialogOnEsc = true });
    }

    private async Task<bool> SaveQueue(JobQueue queue)
    {
        if (string.IsNullOrWhiteSpace(queue.QueueName))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Validation", "Queue name is required.");
            return false;
        }

        // Validate queue name format (Azure Queue naming rules)
        if (!System.Text.RegularExpressions.Regex.IsMatch(queue.QueueName, @"^[a-z0-9]([a-z0-9-]*[a-z0-9])?$"))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Validation", 
                "Queue name must start and end with a letter or number, and can only contain lowercase letters, numbers, and hyphens.");
            return false;
        }

        try
        {
            if (queue.Id == 0)
            {
                await JobQueueService.CreateJobQueueAsync(queue);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Job queue created successfully.");
            }
            else
            {
                await JobQueueService.UpdateJobQueueAsync(queue);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Job queue updated successfully.");
            }

            await LoadJobQueues();
            return true;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save job queue: {ex.Message}");
            return false;
        }
    }

    private async Task DeleteQueue(JobQueue queue)
    {
        if (queue.Jobs.Count > 0)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Cannot Delete", 
                $"This queue is assigned to {queue.Jobs.Count} job(s). Remove the queue assignment from those jobs first.");
            return;
        }

        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to delete the queue '{queue.QueueName}'?",
            "Confirm Delete",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            try
            {
                await JobQueueService.DeleteJobQueueAsync(queue.Id);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Job queue deleted successfully.");
                await LoadJobQueues();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to delete job queue: {ex.Message}");
            }
        }
    }

    #endregion
}
