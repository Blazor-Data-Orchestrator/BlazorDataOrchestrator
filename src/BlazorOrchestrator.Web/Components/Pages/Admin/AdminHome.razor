@page "/admin"
@using Radzen
@using Radzen.Blazor
@using BlazorOrchestrator.Web.Data.Data
@using BlazorOrchestrator.Web.Services
@using BlazorOrchestrator.Web.Components.Pages.Dialogs
@using BlazorDataOrchestrator.Core.Services
@using BlazorDataOrchestrator.Core.Models
@inject JobQueueService JobQueueService
@inject JobGroupService JobGroupService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject AppSettingsService AppSettingsService
@inject BlazorOrchestrator.Web.Services.TimeDisplayService TimeDisplayService
@inject AISettingsService AISettingsService
@inject AIModelCacheService AIModelCacheService
@inject IJSRuntime JSRuntime

<PageTitle>Administration</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
        <RadzenIcon Icon="admin_panel_settings" Style="font-size: 1.5rem;" />
        <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1" Style="margin: 0;">Administration</RadzenText>
    </RadzenStack>

    <RadzenTabs @bind-SelectedIndex="@SelectedTabIndex" Style="width: 100%;">
        <Tabs>
            <RadzenTabsItem Text="Manage Job Groups" Icon="folder_special">
                <RadzenStack Gap="1rem" Style="padding: 1.5rem 0;">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Job Group Configuration</RadzenText>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Text="Add Job Group" Icon="add" ButtonStyle="ButtonStyle.Success" Click="@OpenAddJobGroupDialog" />
                            <RadzenButton Text="Refresh" Icon="refresh" ButtonStyle="ButtonStyle.Light" Click="@LoadJobGroups" Disabled="@IsLoadingJobGroups" />
                        </RadzenStack>
                    </RadzenStack>

                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Style="margin-bottom: 1rem;">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                            Job Groups allow you to organize and categorize your jobs for easier management and filtering.
                        </RadzenText>
                    </RadzenAlert>

                    @if (IsLoadingJobGroups)
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 200px;">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                            <RadzenText TextStyle="TextStyle.Body1">Loading job groups...</RadzenText>
                        </RadzenStack>
                    }
                    else if (!JobGroups.Any())
                    {
                        <RadzenCard Style="padding: 2rem; text-align: center;">
                            <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                                <RadzenIcon Icon="folder_off" Style="font-size: 3rem; color: #9ca3af;" />
                                <RadzenText TextStyle="TextStyle.H6" Style="color: #6b7280; margin: 0;">No job groups configured</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="color: #9ca3af; margin: 0;">
                                    Create a job group to organize your jobs
                                </RadzenText>
                                <RadzenButton Text="Add Job Group" ButtonStyle="ButtonStyle.Primary" Click="@OpenAddJobGroupDialog" />
                            </RadzenStack>
                        </RadzenCard>
                    }
                    else
                    {
                        <RadzenDataGrid @ref="JobGroupGrid" Data="@JobGroups" TItem="JobGroup" 
                                        AllowPaging="true" PageSize="10" PagerHorizontalAlign="HorizontalAlign.Center"
                                        AllowSorting="true" Style="height: auto;">
                            <Columns>
                                <RadzenDataGridColumn TItem="JobGroup" Width="120px" Title="Actions">
                                    <Template Context="group">
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
                                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small"
                                                          Click="@(() => OpenEditJobGroupDialog(group))" />
                                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                                          Variant="Variant.Outlined" Click="@(() => DeleteJobGroup(group))" />
                                        </RadzenStack>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="JobGroup" Property="Id" Title="ID" Width="80px" />
                                <RadzenDataGridColumn TItem="JobGroup" Property="JobGroupName" Title="Group Name" />
                                <RadzenDataGridColumn TItem="JobGroup" Property="CreatedDate" Title="Created Date" Width="180px">
                                    <Template Context="group">
                                        @TimeDisplayService.FormatDateTime(group.CreatedDate)
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="JobGroup" Title="Jobs" Width="100px">
                                    <Template Context="group">
                                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@(group.JobJobGroups?.Count.ToString() ?? "0")" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    }
                </RadzenStack>
            </RadzenTabsItem>
            <RadzenTabsItem Text="Manage Job Queues" Icon="queue">
                <RadzenStack Gap="1rem" Style="padding: 1.5rem 0;">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Job Queue Configuration</RadzenText>
                        <RadzenButton Text="Add New Queue" Icon="add" ButtonStyle="ButtonStyle.Success" Click="@OpenAddQueueDialog" />
                    </RadzenStack>

                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Style="margin-bottom: 1rem;">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                            Job Queues allow you to route job execution to specific Azure Queues based on container size or other requirements. 
                            Jobs can be assigned to a specific queue in the Job Details page.
                        </RadzenText>
                    </RadzenAlert>

                    @if (IsLoading)
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 200px;">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                            <RadzenText TextStyle="TextStyle.Body1">Loading job queues...</RadzenText>
                        </RadzenStack>
                    }
                    else if (!JobQueues.Any())
                    {
                        <RadzenCard Style="padding: 2rem; text-align: center;">
                            <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                                <RadzenIcon Icon="queue" Style="font-size: 3rem; color: #9ca3af;" />
                                <RadzenText TextStyle="TextStyle.H6" Style="color: #6b7280; margin: 0;">No job queues configured</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="color: #9ca3af; margin: 0;">
                                    Create a job queue to route jobs to specific Azure Queues
                                </RadzenText>
                                <RadzenButton Text="Add New Queue" ButtonStyle="ButtonStyle.Primary" Click="@OpenAddQueueDialog" />
                            </RadzenStack>
                        </RadzenCard>
                    }
                    else
                    {
                        <RadzenDataGrid @ref="QueueGrid" Data="@JobQueues" TItem="JobQueue" 
                                        AllowPaging="true" PageSize="10" PagerHorizontalAlign="HorizontalAlign.Center"
                                        AllowSorting="true" Style="height: auto;">
                            <Columns>
                                <RadzenDataGridColumn TItem="JobQueue" Width="120px" Title="Actions">
                                    <Template Context="queue">
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
                                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small"
                                                          Click="@(() => OpenEditQueueDialog(queue))" />
                                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                                          Variant="Variant.Outlined" Click="@(() => DeleteQueue(queue))" />
                                        </RadzenStack>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="JobQueue" Property="Id" Title="ID" Width="80px" />
                                <RadzenDataGridColumn TItem="JobQueue" Property="QueueName" Title="Queue Name" />
                                <RadzenDataGridColumn TItem="JobQueue" Property="CreatedDate" Title="Created Date" Width="180px">
                                    <Template Context="queue">
                                        @TimeDisplayService.FormatDateTime(queue.CreatedDate)
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="JobQueue" Property="CreatedBy" Title="Created By" Width="150px" />
                                <RadzenDataGridColumn TItem="JobQueue" Title="Jobs Using" Width="100px">
                                    <Template Context="queue">
                                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@queue.Jobs.Count.ToString()" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    }
                </RadzenStack>
            </RadzenTabsItem>
            <RadzenTabsItem Text="Timezone Settings" Icon="settings">
                <RadzenStack Gap="1rem" Style="padding: 1.5rem 0;">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Timezone Settings</RadzenText>
                    </RadzenStack>

                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Style="margin-bottom: 1rem;">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                            The timezone setting affects how dates and times are displayed throughout the application.
                        </RadzenText>
                    </RadzenAlert>

                    <RadzenCard Style="padding: 1.5rem;">
                        <RadzenStack Gap="1.5rem">
                            <RadzenStack Gap="0.5rem">
                                <RadzenLabel Text="Display Timezone" Component="TimezoneOffset" Style="font-weight: 600;" />
                                <RadzenDropDown @bind-Value="@SelectedTimezoneOffset" 
                                                Data="@AvailableTimezones" 
                                                TextProperty="Label" 
                                                ValueProperty="Value"
                                                Style="width: 100%; max-width: 400px;" 
                                                Name="TimezoneOffset"
                                                Change="@OnTimezoneChanged" />
                                <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">
                                    Select the timezone for displaying dates and times in logs and other views.
                                </RadzenText>
                            </RadzenStack>

                            <RadzenStack Gap="0.5rem">
                                <RadzenLabel Text="Preview" Style="font-weight: 600;" />
                                <RadzenCard Style="background: #f8fafc; padding: 1rem;">
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="2rem" AlignItems="AlignItems.Center">
                                        <RadzenStack Gap="0.25rem">
                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">Current UTC Time</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Body1" Style="font-family: monospace;">@DateTime.UtcNow.ToString("g")</RadzenText>
                                        </RadzenStack>
                                        <RadzenIcon Icon="arrow_forward" Style="color: #6b7280;" />
                                        <RadzenStack Gap="0.25rem">
                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">Display Time (@SelectedTimezoneOffset)</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Body1" Style="font-family: monospace;">@TimeDisplayService.FormatCurrentTime()</RadzenText>
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Style="margin-top: 1rem;">
                                <RadzenButton Text="Save Settings" Icon="save" ButtonStyle="ButtonStyle.Success" 
                                              Click="@SaveSettings" Disabled="@IsSavingSettings" />
                                @if (IsSavingSettings)
                                {
                                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                                }
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenStack>
            </RadzenTabsItem>
            <RadzenTabsItem Text="AI Settings" Icon="smart_toy">
                <RadzenStack Gap="1rem" Style="padding: 1.5rem 0;">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">AI Service Configuration</RadzenText>
                    </RadzenStack>

                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Style="margin-bottom: 1rem;">
                        <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">
                            Configure AI settings for the code assistant feature. These settings are stored securely in Azure Table Storage.
                        </RadzenText>
                    </RadzenAlert>

                    @if (IsLoadingAISettings)
                    {
                        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 200px;">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                            <RadzenText TextStyle="TextStyle.Body1">Loading AI settings...</RadzenText>
                        </RadzenStack>
                    }
                    else
                    {
                        <RadzenCard Style="padding: 1.5rem;">
                            <RadzenStack Gap="1.5rem">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenLabel Text="AI Service Type" Component="AIServiceType" Style="font-weight: 600;" />
                                    <RadzenDropDown @bind-Value="@AIServiceType" 
                                                    Data="@AIServiceTypes" 
                                                    Style="width: 100%; max-width: 400px;" 
                                                    Name="AIServiceType"
                                                    Change="@OnAIServiceTypeChanged" />
                                    <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">
                                        Select the AI service provider to use for code assistance.
                                    </RadzenText>
                                </RadzenStack>

                                <RadzenStack Gap="0.5rem">
                                    <RadzenLabel Text="API Key" Component="ApiKey" Style="font-weight: 600;" />
                                    <RadzenTextBox @bind-Value="@AIApiKey" 
                                                   Style="width: 100%; max-width: 400px;" 
                                                   Name="ApiKey"
                                                   Placeholder="@GetApiKeyPlaceholder()"
                                                   @oninput="@OnApiKeyInput" />
                                    <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">
                                        @GetApiKeyHelpText()
                                    </RadzenText>
                                </RadzenStack>

                                <RadzenStack Gap="0.5rem">
                                    <RadzenLabel Text="@GetModelLabel()" Component="AIModel" Style="font-weight: 600;" />
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                        <RadzenDropDown Data="@AvailableModels" @bind-Value="@AIModel" 
                                                        Style="width: 100%; max-width: 350px;"
                                                        Name="AIModel"
                                                        AllowFiltering="true" 
                                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                                        AllowClear="true"
                                                        Placeholder="@GetModelPlaceholder()" />
                                        <RadzenButton Icon="refresh" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" 
                                                      Click="@RefreshModelsFromApi" IsBusy="@IsLoadingModels"
                                                      title="Refresh models from API" />
                                    </RadzenStack>
                                    <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">
                                        @GetModelHelpText()
                                        @if (IsLoadingModels)
                                        {
                                            <text> Loading models...</text>
                                        }
                                    </RadzenText>
                                </RadzenStack>

                                @if (AIServiceType == "Azure OpenAI")
                                {
                                    <RadzenStack Gap="0.5rem">
                                        <RadzenLabel Text="Embedding Model Deployment Name" Component="EmbeddingModel" Style="font-weight: 600;" />
                                        <RadzenTextBox @bind-Value="@AIEmbeddingModel" 
                                                       Style="width: 100%; max-width: 400px;" 
                                                       Name="EmbeddingModel"
                                                       Placeholder="text-embedding-ada-002" />
                                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">
                                            The deployment name of your Azure OpenAI embedding model (optional).
                                        </RadzenText>
                                    </RadzenStack>

                                    <RadzenStack Gap="0.5rem">
                                        <RadzenLabel Text="Azure OpenAI Endpoint" Component="Endpoint" Style="font-weight: 600;" />
                                        <RadzenTextBox @bind-Value="@AIEndpoint" 
                                                       Style="width: 100%; max-width: 400px;" 
                                                       Name="Endpoint"
                                                       Placeholder="https://your-resource.openai.azure.com/" />
                                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">
                                            Your Azure OpenAI resource endpoint URL.
                                        </RadzenText>
                                    </RadzenStack>

                                    <RadzenStack Gap="0.5rem">
                                        <RadzenLabel Text="API Version" Component="ApiVersion" Style="font-weight: 600;" />
                                        <RadzenTextBox @bind-Value="@AIApiVersion" 
                                                       Style="width: 100%; max-width: 400px;" 
                                                       Name="ApiVersion"
                                                       Placeholder="2024-02-15-preview" />
                                        <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">
                                            The Azure OpenAI API version to use.
                                        </RadzenText>
                                    </RadzenStack>
                                }

                                @if (!IsAISettingsEntered)
                                {
                                    <RadzenStack Gap="0.5rem">
                                        @if (AIServiceType == "OpenAI")
                                        {
                                            <RadzenButton Text="Get an OpenAI API Key" Icon="open_in_new" 
                                                          ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Outlined"
                                                          Click="@GetOpenAIApiKey" Style="max-width: 400px;" />
                                        }
                                        else if (AIServiceType == "Azure OpenAI")
                                        {
                                            <RadzenButton Text="Learn how to create Azure OpenAI resource" Icon="open_in_new" 
                                                          ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Outlined"
                                                          Click="@GetAzureOpenAIApiKey" Style="max-width: 400px;" />
                                        }
                                        else if (AIServiceType == "Anthropic")
                                        {
                                            <RadzenButton Text="Get an Anthropic API Key" Icon="open_in_new" 
                                                          ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Outlined"
                                                          Click="@GetAnthropicApiKey" Style="max-width: 400px;" />
                                        }
                                        else if (AIServiceType == "Google AI")
                                        {
                                            <RadzenButton Text="Get a Google AI API Key" Icon="open_in_new" 
                                                          ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Outlined"
                                                          Click="@GetGoogleAIApiKey" Style="max-width: 400px;" />
                                        }
                                    </RadzenStack>
                                }

                                @if (AISettings.IsConfigured)
                                {
                                    <RadzenCard Style="background: #f0fdf4; padding: 1rem; border: 1px solid #86efac;">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                            <RadzenIcon Icon="check_circle" Style="color: #16a34a;" />
                                            <RadzenText TextStyle="TextStyle.Body2" Style="color: #166534; margin: 0;">
                                                AI service is configured and ready to use.
                                            </RadzenText>
                                        </RadzenStack>
                                    </RadzenCard>
                                }
                                else
                                {
                                    <RadzenCard Style="background: #fef3c7; padding: 1rem; border: 1px solid #fcd34d;">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                            <RadzenIcon Icon="warning" Style="color: #d97706;" />
                                            <RadzenText TextStyle="TextStyle.Body2" Style="color: #92400e; margin: 0;">
                                                AI service is not configured. Enter an API key to enable AI features.
                                            </RadzenText>
                                        </RadzenStack>
                                    </RadzenCard>
                                }

                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Style="margin-top: 1rem;">
                                    <RadzenButton Text="Save AI Settings" Icon="save" ButtonStyle="ButtonStyle.Success" 
                                                  Click="@SaveAISettings" Disabled="@IsSavingAISettings" />
                                    @if (IsSavingAISettings)
                                    {
                                        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                                    }
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    }
                </RadzenStack>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
</RadzenStack>

@code {
    private int SelectedTabIndex { get; set; } = 0;
    private bool IsLoading { get; set; } = true;
    private bool IsLoadingJobGroups { get; set; } = true;
    private List<JobQueue> JobQueues { get; set; } = new();
    private List<JobGroup> JobGroups { get; set; } = new();
    private RadzenDataGrid<JobQueue>? QueueGrid;
    private RadzenDataGrid<JobGroup>? JobGroupGrid;

    // Settings fields
    private string SelectedTimezoneOffset { get; set; } = "-08:00";
    private List<TimezoneOption> AvailableTimezones { get; set; } = new();
    private bool IsSavingSettings { get; set; } = false;

    // AI Settings fields
    private AISettings AISettings { get; set; } = new();
    private string AIServiceType { get; set; } = "OpenAI";
    private string AIApiKey { get; set; } = "";
    private string AIModel { get; set; } = "gpt-4-turbo-preview";
    private string AIEndpoint { get; set; } = "";
    private string AIApiVersion { get; set; } = "";
    private string AIEmbeddingModel { get; set; } = "";
    private bool IsLoadingAISettings { get; set; } = true;
    private bool IsSavingAISettings { get; set; } = false;
    private bool IsAISettingsEntered { get; set; } = false;
    private bool IsLoadingModels { get; set; } = false;
    private List<string> AvailableModels { get; set; } = new();
    private List<string> AIServiceTypes { get; set; } = new() { "OpenAI", "Azure OpenAI", "Anthropic", "Google AI" };

    protected override async Task OnInitializedAsync()
    {
        // Load settings
        LoadSettings();
        
        // Run sequentially to avoid DbContext concurrency issues
        await LoadJobGroups();
        await LoadJobQueues();
        await LoadAISettings();
    }

    #region Settings

    private void LoadSettings()
    {
        AvailableTimezones = AppSettingsService.GetAvailableTimezones();
        SelectedTimezoneOffset = AppSettingsService.GetTimezoneOffsetString();
    }

    private void OnTimezoneChanged()
    {
        // Trigger UI refresh to update the preview
        StateHasChanged();
    }

    private async Task SaveSettings()
    {
        IsSavingSettings = true;
        StateHasChanged();

        try
        {
            await AppSettingsService.SetTimezoneOffsetAsync(SelectedTimezoneOffset);
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Settings saved successfully. Please refresh the page for changes to take full effect.");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save settings: {ex.Message}");
        }
        finally
        {
            IsSavingSettings = false;
            StateHasChanged();
        }
    }

    #endregion

    #region AI Settings

    private async Task LoadAISettings()
    {
        IsLoadingAISettings = true;
        StateHasChanged();

        try
        {
            AISettings = await AISettingsService.GetSettingsAsync();
            AIServiceType = AISettings.AIServiceType;
            AIApiKey = AISettings.ApiKey;
            AIModel = AISettings.AIModel;
            AIEndpoint = AISettings.Endpoint;
            AIApiVersion = AISettings.ApiVersion;
            AIEmbeddingModel = AISettings.EmbeddingModel;
            IsAISettingsEntered = !string.IsNullOrWhiteSpace(AIApiKey);

            // Load available models from cache or API
            await LoadAvailableModelsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load AI settings: {ex.Message}");
        }
        finally
        {
            IsLoadingAISettings = false;
            StateHasChanged();
        }
    }

    private async void OnAIServiceTypeChanged()
    {
        AIModel = AIServiceType switch
        {
            "OpenAI" => string.IsNullOrWhiteSpace(AIModel) || !AIModel.StartsWith("gpt") ? "gpt-4-turbo-preview" : AIModel,
            "Anthropic" => string.IsNullOrWhiteSpace(AIModel) || !AIModel.StartsWith("claude") ? "claude-sonnet-4-20250514" : AIModel,
            "Google AI" => string.IsNullOrWhiteSpace(AIModel) || !AIModel.StartsWith("gemini") ? "gemini-1.5-pro" : AIModel,
            _ => AIModel
        };
        await LoadAvailableModelsAsync();
        StateHasChanged();
    }

    private void OnApiKeyInput(ChangeEventArgs args)
    {
        AIApiKey = args.Value?.ToString() ?? "";
        IsAISettingsEntered = !string.IsNullOrWhiteSpace(AIApiKey);
    }

    private async Task GetOpenAIApiKey()
    {
        await JSRuntime.InvokeVoidAsync("open", "https://platform.openai.com/account/api-keys");
    }

    private async Task GetAzureOpenAIApiKey()
    {
        await JSRuntime.InvokeVoidAsync("open", "https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/create-resource?pivots=web-portal");
    }

    private async Task GetAnthropicApiKey()
    {
        await JSRuntime.InvokeVoidAsync("open", "https://console.anthropic.com/settings/keys");
    }

    private async Task GetGoogleAIApiKey()
    {
        await JSRuntime.InvokeVoidAsync("open", "https://aistudio.google.com/app/apikey");
    }

    private string GetApiKeyPlaceholder() => AIServiceType switch
    {
        "OpenAI" => "sk-...",
        "Azure OpenAI" => "Your Azure OpenAI API Key",
        "Anthropic" => "sk-ant-...",
        "Google AI" => "Your Google AI API Key",
        _ => "API Key"
    };

    private string GetApiKeyHelpText() => AIServiceType switch
    {
        "OpenAI" => "Your OpenAI API key (starts with sk-).",
        "Azure OpenAI" => "Your Azure OpenAI API key from the Azure portal.",
        "Anthropic" => "Your Anthropic API key from the Anthropic Console.",
        "Google AI" => "Your Google AI API key from Google AI Studio.",
        _ => "Your API key for the selected AI service."
    };

    private string GetModelLabel() => AIServiceType switch
    {
        "Azure OpenAI" => "Model Deployment Name",
        _ => "Model"
    };

    private string GetModelPlaceholder() => AIServiceType switch
    {
        "OpenAI" => "gpt-4-turbo-preview",
        "Azure OpenAI" => "gpt-4",
        "Anthropic" => "claude-sonnet-4-20250514",
        "Google AI" => "gemini-1.5-pro",
        _ => "Model name"
    };

    private string GetModelHelpText() => AIServiceType switch
    {
        "OpenAI" => "The OpenAI model to use (e.g., gpt-4-turbo-preview, gpt-4o).",
        "Azure OpenAI" => "The deployment name of your Azure OpenAI model.",
        "Anthropic" => "The Anthropic model to use (e.g., claude-sonnet-4-20250514, claude-3-5-haiku-latest).",
        "Google AI" => "The Google AI model to use (e.g., gemini-1.5-pro, gemini-1.5-flash).",
        _ => "The AI model to use for code assistance."
    };

    private async Task LoadAvailableModelsAsync()
    {
        IsLoadingModels = true;
        StateHasChanged();

        try
        {
            AvailableModels = await AIModelCacheService.GetModelsAsync(
                AIServiceType, AIApiKey, AIEndpoint, AIApiVersion);

            // Ensure the currently selected model is in the list
            if (!string.IsNullOrWhiteSpace(AIModel) && !AvailableModels.Contains(AIModel))
            {
                AvailableModels.Insert(0, AIModel);
            }
        }
        catch
        {
            AvailableModels = AIModelCacheService.GetDefaultModels(AIServiceType);
        }
        finally
        {
            IsLoadingModels = false;
            StateHasChanged();
        }
    }

    private async Task RefreshModelsFromApi()
    {
        if (string.IsNullOrWhiteSpace(AIApiKey))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "API Key Required", 
                "Enter an API key first to fetch available models from the provider.");
            return;
        }

        IsLoadingModels = true;
        StateHasChanged();

        try
        {
            AvailableModels = await AIModelCacheService.RefreshModelsAsync(
                AIServiceType, AIApiKey, AIEndpoint, AIApiVersion);

            if (!string.IsNullOrWhiteSpace(AIModel) && !AvailableModels.Contains(AIModel))
            {
                AvailableModels.Insert(0, AIModel);
            }

            NotificationService.Notify(NotificationSeverity.Success, "Models Refreshed", 
                $"Found {AvailableModels.Count} available models.");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Refresh Failed", 
                $"Could not fetch models: {ex.Message}");
            AvailableModels = AIModelCacheService.GetDefaultModels(AIServiceType);
        }
        finally
        {
            IsLoadingModels = false;
            StateHasChanged();
        }
    }

    private async Task SaveAISettings()
    {
        IsSavingAISettings = true;
        StateHasChanged();

        try
        {
            // Validate API key format for OpenAI
            if (AIServiceType == "OpenAI" && !string.IsNullOrWhiteSpace(AIApiKey) && !AIApiKey.StartsWith("sk-"))
            {
                NotificationService.Notify(NotificationSeverity.Warning, "Validation", "OpenAI API keys must start with 'sk-'.");
                return;
            }

            // Validate Azure OpenAI settings
            if (AIServiceType == "Azure OpenAI" && !string.IsNullOrWhiteSpace(AIApiKey))
            {
                if (string.IsNullOrWhiteSpace(AIEndpoint))
                {
                    NotificationService.Notify(NotificationSeverity.Warning, "Validation", "Azure OpenAI Endpoint is required.");
                    return;
                }
            }

            var settings = new AISettings
            {
                AIServiceType = AIServiceType,
                ApiKey = AIApiKey,
                AIModel = AIModel,
                Endpoint = AIEndpoint,
                ApiVersion = AIApiVersion,
                EmbeddingModel = AIEmbeddingModel
            };

            await AISettingsService.SaveSettingsAsync(settings);
            AISettings = settings;

            NotificationService.Notify(NotificationSeverity.Success, "Success", "AI settings saved successfully.");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save AI settings: {ex.Message}");
        }
        finally
        {
            IsSavingAISettings = false;
            StateHasChanged();
        }
    }

    #endregion

    #region Job Groups

    private async Task LoadJobGroups()
    {
        IsLoadingJobGroups = true;
        StateHasChanged();

        try
        {
            // Load all job groups with their job associations in a single query
            JobGroups = await JobGroupService.GetJobGroupsWithJobsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load job groups: {ex.Message}");
        }
        finally
        {
            IsLoadingJobGroups = false;
            StateHasChanged();
        }
    }

    private async Task OpenAddJobGroupDialog()
    {
        var result = await DialogService.OpenAsync<JobGroupDialog>("Add Job Group",
            new Dictionary<string, object>
            {
                { "OnSaved", EventCallback.Factory.Create<(string Name, bool IsActive)>(this, OnJobGroupCreated) },
                { "OnCancel", EventCallback.Factory.Create(this, () => DialogService.Close()) }
            },
            new DialogOptions { Width = "450px", CloseDialogOnEsc = true });
    }

    private async Task OpenEditJobGroupDialog(JobGroup group)
    {
        var result = await DialogService.OpenAsync<JobGroupDialog>("Edit Job Group",
            new Dictionary<string, object>
            {
                { "ExistingJobGroup", group },
                { "OnSaved", EventCallback.Factory.Create<(string Name, bool IsActive)>(this, async (data) => await OnJobGroupUpdated(group.Id, data)) },
                { "OnCancel", EventCallback.Factory.Create(this, () => DialogService.Close()) }
            },
            new DialogOptions { Width = "450px", CloseDialogOnEsc = true });
    }

    private async Task OnJobGroupCreated((string Name, bool IsActive) data)
    {
        try
        {
            var group = await JobGroupService.CreateJobGroupAsync(data.Name);

            DialogService.Close();
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"Job group '{data.Name}' created successfully.");
            await LoadJobGroups();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to create job group: {ex.Message}");
        }
    }

    private async Task OnJobGroupUpdated(int id, (string Name, bool IsActive) data)
    {
        try
        {
            var group = await JobGroupService.GetJobGroupByIdAsync(id);
            if (group != null)
            {
                group.JobGroupName = data.Name;
                await JobGroupService.UpdateJobGroupAsync(group);

                DialogService.Close();
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Job group '{data.Name}' updated successfully.");
                await LoadJobGroups();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to update job group: {ex.Message}");
        }
    }

    private async Task DeleteJobGroup(JobGroup group)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to delete the job group '{group.JobGroupName}'? This will remove all job associations with this group.",
            "Delete Job Group",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            try
            {
                await JobGroupService.DeleteJobGroupAsync(group.Id);
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Job group '{group.JobGroupName}' deleted successfully.");
                await LoadJobGroups();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to delete job group: {ex.Message}");
            }
        }
    }

    #endregion

    #region Job Queues

    private async Task LoadJobQueues()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            JobQueues = await JobQueueService.GetAllJobQueuesAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load job queues: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task OpenAddQueueDialog()
    {
        var newQueue = new JobQueue();
        await OpenQueueDialog(newQueue, "Add New Job Queue");
    }

    private async Task OpenEditQueueDialog(JobQueue queue)
    {
        await OpenQueueDialog(queue, $"Edit Job Queue - {queue.QueueName}");
    }

    private async Task OpenQueueDialog(JobQueue queue, string title)
    {
        var isNew = queue.Id == 0;
        var queueName = queue.QueueName ?? "";

        var result = await DialogService.OpenAsync(title, ds =>
            @<RadzenStack Gap="1.5rem" Style="min-width: 400px; padding: 1rem;">
                <RadzenStack Gap="0.5rem">
                    <RadzenLabel Text="Queue Name" Component="QueueName" Style="font-weight: 500;" />
                    <RadzenTextBox @bind-Value="@queueName" Name="QueueName" Style="width: 100%;" 
                                   Placeholder="e.g., jobs-large-container" />
                    <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280;">
                        This name will be used as the Azure Queue name. Use lowercase letters, numbers, and hyphens only.
                    </RadzenText>
                </RadzenStack>

                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                    <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => ds.Close(false))" />
                    <RadzenButton Text="@(isNew ? "Create" : "Save")" ButtonStyle="ButtonStyle.Primary" 
                                  Click="@(async () => {
                                      queue.QueueName = queueName;
                                      var success = await SaveQueue(queue);
                                      if (success) ds.Close(true);
                                  })" />
                </RadzenStack>
            </RadzenStack>,
        new DialogOptions { ShowTitle = true, CloseDialogOnEsc = true });
    }

    private async Task<bool> SaveQueue(JobQueue queue)
    {
        if (string.IsNullOrWhiteSpace(queue.QueueName))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Validation", "Queue name is required.");
            return false;
        }

        // Validate queue name format (Azure Queue naming rules)
        if (!System.Text.RegularExpressions.Regex.IsMatch(queue.QueueName, @"^[a-z0-9]([a-z0-9-]*[a-z0-9])?$"))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Validation", 
                "Queue name must start and end with a letter or number, and can only contain lowercase letters, numbers, and hyphens.");
            return false;
        }

        try
        {
            if (queue.Id == 0)
            {
                await JobQueueService.CreateJobQueueAsync(queue);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Job queue created successfully.");
            }
            else
            {
                await JobQueueService.UpdateJobQueueAsync(queue);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Job queue updated successfully.");
            }

            await LoadJobQueues();
            return true;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save job queue: {ex.Message}");
            return false;
        }
    }

    private async Task DeleteQueue(JobQueue queue)
    {
        if (queue.Jobs.Count > 0)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Cannot Delete", 
                $"This queue is assigned to {queue.Jobs.Count} job(s). Remove the queue assignment from those jobs first.");
            return;
        }

        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to delete the queue '{queue.QueueName}'?",
            "Confirm Delete",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            try
            {
                await JobQueueService.DeleteJobQueueAsync(queue.Id);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Job queue deleted successfully.");
                await LoadJobQueues();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to delete job queue: {ex.Message}");
            }
        }
    }

    #endregion
}
