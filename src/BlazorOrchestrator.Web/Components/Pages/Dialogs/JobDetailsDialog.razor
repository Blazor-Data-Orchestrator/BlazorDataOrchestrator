@using BlazorOrchestrator.Web.Data.Data
@using BlazorOrchestrator.Web.Services
@using BlazorOrchestrator.Web.Components.Pages.Dialogs
@using Radzen
@using Radzen.Blazor
@inject JobService JobService
@inject JobGroupService JobGroupService
@inject NotificationService NotificationService
@inject DialogService DialogService

@if (IsLoading)
{
    <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="height: 200px; min-width: 800px;">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText TextStyle="TextStyle.Body1">Loading job details...</RadzenText>
    </RadzenStack>
}
else if (Job == null)
{
    <RadzenStack Style="min-width: 400px;">
        <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter">
            Job not found.
        </RadzenAlert>
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Style="margin-top: 1rem;">
            <RadzenButton Text="Close" ButtonStyle="ButtonStyle.Light" Click="@OnCloseClick" />
        </RadzenStack>
    </RadzenStack>
}
else
{
    <RadzenStack Gap="1rem" Style="min-width: 850px;">
        <RadzenTabs @bind-SelectedIndex="@SelectedTabIndex" Style="width: 100%;">
            <Tabs>
                <RadzenTabsItem Text="Details" Icon="info">
                    @* Details Tab Content *@
                    <RadzenStack Gap="1rem" Style="padding: 1rem 0;">
                        <RadzenButton Text="Run Job Now" Icon="play_arrow" ButtonStyle="ButtonStyle.Primary" 
                                      Size="ButtonSize.Small" Style="align-self: flex-start;" />

                        <RadzenStack Gap="1rem">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
                                <RadzenStack Gap="0.5rem" Style="flex: 1; min-width: 200px;">
                                    <RadzenLabel Text="Base Job Name" Component="JobName" Style="font-weight: 500;" />
                                    <RadzenTextBox @bind-Value="@Job.JobName" Name="JobName" Style="width: 100%;" />
                                </RadzenStack>

                                <RadzenStack Gap="0.5rem" Style="flex: 1; min-width: 200px;">
                                    <RadzenLabel Text="Environment" Component="Environment" Style="font-weight: 500;" />
                                    <RadzenDropDown @bind-Value="@Job.JobEnvironment" Data="@Environments" 
                                                    Name="Environment" Style="width: 100%;" />
                                </RadzenStack>

                                <RadzenStack Gap="0.5rem" Style="flex: 1; min-width: 200px;">
                                    <RadzenLabel Text="Job Group" Component="JobGroup" Style="font-weight: 500;" />
                                    <RadzenDropDown @bind-Value="@selectedJobGroupId" Data="@AvailableJobGroups" 
                                                    TextProperty="JobGroupName" ValueProperty="Id"
                                                    AllowClear="true" Placeholder="Select a job group..."
                                                    Name="JobGroup" Style="width: 100%;" />
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenLabel Text="Enabled" Component="Enabled" Style="font-weight: 500;" />
                                <RadzenCheckBox @bind-Value="@Job.JobEnabled" Name="Enabled" />
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenTabsItem>

                <RadzenTabsItem Text="Schedule" Icon="schedule">
                    @* Schedule Tab Content *@
                    <RadzenStack Gap="1rem" Style="padding: 1rem 0;">
                        <RadzenButton Text="Add New Job Schedule" Icon="add" ButtonStyle="ButtonStyle.Success" 
                                      Size="ButtonSize.Small" Click="@OpenAddScheduleDialog" Style="align-self: flex-start;" />

                        <RadzenDataGrid @ref="ScheduleGrid" Data="@Schedules" TItem="JobSchedule" 
                                        AllowPaging="true" PageSize="5" PagerHorizontalAlign="HorizontalAlign.Center"
                                        AllowSorting="true" Style="height: auto;" Density="Density.Compact">
                            <Columns>
                                <RadzenDataGridColumn TItem="JobSchedule" Width="60px" Title="">
                                    <Template Context="schedule">
                                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.ExtraSmall"
                                                      Click="@(() => OpenEditScheduleDialog(schedule))" />
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="JobSchedule" Property="ScheduleName" Title="Schedule Name" />
                                <RadzenDataGridColumn TItem="JobSchedule" Property="Enabled" Title="Enabled" Width="80px">
                                    <Template Context="schedule">
                                        <RadzenCheckBox Value="@schedule.Enabled" Disabled="true" />
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="JobSchedule" Title="Run Once" Width="80px">
                                    <Template Context="schedule">
                                        <RadzenText>@(schedule.RunEveryHour == null ? "True" : "False")</RadzenText>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="JobSchedule" Property="InProcess" Title="In Process" Width="90px">
                                    <Template Context="schedule">
                                        <RadzenCheckBox Value="@schedule.InProcess" Disabled="true" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    </RadzenStack>
                </RadzenTabsItem>

                <RadzenTabsItem Text="Parameters" Icon="tune">
                    @* Parameters Tab Content *@
                    <RadzenStack Gap="1rem" Style="padding: 1rem 0;">
                        <RadzenButton Text="Add New Job Parameter" Icon="add" ButtonStyle="ButtonStyle.Success" 
                                      Size="ButtonSize.Small" Click="@OpenAddParameterDialog" Style="align-self: flex-start;" />

                        <RadzenDataGrid @ref="ParameterGrid" Data="@Parameters" TItem="JobDatum" 
                                        AllowPaging="true" PageSize="5" PagerHorizontalAlign="HorizontalAlign.Center"
                                        AllowSorting="true" Style="height: auto;" Density="Density.Compact">
                            <Columns>
                                <RadzenDataGridColumn TItem="JobDatum" Width="80px" Title="">
                                    <Template Context="param">
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
                                            <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.ExtraSmall"
                                                          Click="@(() => OpenEditParameterDialog(param))" />
                                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall"
                                                          Variant="Variant.Outlined" Click="@(() => DeleteParameter(param.Id))" />
                                        </RadzenStack>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="JobDatum" Property="JobFieldDescription" Title="Field Description" />
                                <RadzenDataGridColumn TItem="JobDatum" Property="JobStringValue" Title="String Value" />
                                <RadzenDataGridColumn TItem="JobDatum" Property="JobIntValue" Title="Int Value" Width="80px" />
                                <RadzenDataGridColumn TItem="JobDatum" Property="JobDateValue" Title="Date Value" Width="120px">
                                    <Template Context="param">
                                        @(param.JobDateValue?.ToString("g") ?? "-")
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    </RadzenStack>
                </RadzenTabsItem>

                <RadzenTabsItem Text="Logs" Icon="list_alt">
                    @* Logs Tab Content *@
                    <RadzenStack Gap="1rem" Style="padding: 1rem 0;">
                        <RadzenDataGrid @ref="LogsGrid" Data="@Logs" TItem="LogEntry" 
                                        AllowPaging="true" PageSize="5" PagerHorizontalAlign="HorizontalAlign.Center"
                                        AllowSorting="true" Style="height: auto;" Density="Density.Compact">
                            <Columns>
                                <RadzenDataGridColumn TItem="LogEntry" Property="Id" Title="Id" Width="60px" />
                                <RadzenDataGridColumn TItem="LogEntry" Property="Level" Title="Level" Width="80px">
                                    <Template Context="log">
                                        <RadzenBadge BadgeStyle="@GetLogLevelStyle(log.Level)" Text="@log.Level" />
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="LogEntry" Property="CreatedDate" Title="Created Date" Width="150px">
                                    <Template Context="log">
                                        @log.CreatedDate.ToString("g")
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="LogEntry" Property="Message" Title="Message" />
                            </Columns>
                        </RadzenDataGrid>
                    </RadzenStack>
                </RadzenTabsItem>

                <RadzenTabsItem Text="Code" Icon="code">
                    @* Code Tab Content *@
                    <RadzenStack Gap="1rem" Style="padding: 1rem 0;">
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: 600;">Existing Code file</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" Style="font-family: monospace; background: #f1f5f9; padding: 0.5rem; border-radius: 4px;">
                                @(string.IsNullOrEmpty(Job.JobCodeFile) ? "No code file uploaded" : Job.JobCodeFile)
                            </RadzenText>
                        </RadzenStack>

                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: 600;">Upload nuget package file</RadzenText>
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                <InputFile OnChange="@OnFileSelected" accept=".nupkg,.zip" />
                                @if (SelectedFile != null)
                                {
                                    <RadzenText TextStyle="TextStyle.Body2">@SelectedFile.Name</RadzenText>
                                }
                                else
                                {
                                    <RadzenText TextStyle="TextStyle.Body2" Style="color: #6b7280;">No file chosen</RadzenText>
                                }
                            </RadzenStack>
                            <RadzenButton Text="Upload nuget package file" Icon="upload" ButtonStyle="ButtonStyle.Primary" 
                                          Size="ButtonSize.Small" Click="@UploadCodeFile" Disabled="@(SelectedFile == null || IsUploading)" 
                                          Style="align-self: flex-start;" />
                            @if (IsUploading)
                            {
                                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                            }
                        </RadzenStack>
                    </RadzenStack>
                </RadzenTabsItem>
            </Tabs>
        </RadzenTabs>

        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Style="margin-top: 0.5rem;">
            <RadzenButton Text="Delete Job" Icon="delete" ButtonStyle="ButtonStyle.Danger" 
                          Variant="Variant.Outlined" Size="ButtonSize.Small" Click="@DeleteJob" />
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@OnCloseClick" />
                <RadzenButton Text="Save" Icon="save" ButtonStyle="ButtonStyle.Success" Click="@SaveJob" />
            </RadzenStack>
        </RadzenStack>
    </RadzenStack>
}

@code {
    [Parameter]
    public int JobId { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback OnJobDeleted { get; set; }

    [Parameter]
    public EventCallback OnJobSaved { get; set; }

    private Job? Job { get; set; }
    private List<JobSchedule> Schedules { get; set; } = new();
    private List<JobDatum> Parameters { get; set; } = new();
    private List<LogEntry> Logs { get; set; } = new();
    private List<string> Environments { get; set; } = new();
    
    // Job Groups
    private List<JobGroup> AvailableJobGroups { get; set; } = new();
    private int? selectedJobGroupId = null;

    private bool IsLoading { get; set; } = true;
    private bool IsUploading { get; set; } = false;
    private int SelectedTabIndex { get; set; } = 0;
    private IBrowserFile? SelectedFile { get; set; }

    private RadzenDataGrid<JobSchedule>? ScheduleGrid;
    private RadzenDataGrid<JobDatum>? ParameterGrid;
    private RadzenDataGrid<LogEntry>? LogsGrid;

    protected override async Task OnInitializedAsync()
    {
        await LoadJobData();
    }

    private async Task LoadJobData()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            Environments = JobService.GetEnvironments();
            Job = await JobService.GetJobByIdAsync(JobId);
            
            // Load available job groups
            AvailableJobGroups = await JobGroupService.GetActiveJobGroupsAsync();
            
            if (Job != null)
            {
                Schedules = await JobService.GetJobSchedulesAsync(JobId);
                Parameters = await JobService.GetJobParametersAsync(JobId);
                await LoadLogs();
                
                // Load current job group assignment (single group)
                var currentGroups = await JobGroupService.GetJobGroupsForJobAsync(JobId);
                selectedJobGroupId = currentGroups.FirstOrDefault()?.Id;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load job: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadLogs()
    {
        // Load job instances as log entries
        var instances = await JobService.GetJobInstancesAsync(JobId);
        Logs = instances.Select(i => new LogEntry
        {
            Id = i.Id,
            Level = i.HasError ? "Error" : (i.InProcess ? "Info" : "Success"),
            CreatedDate = i.CreatedDate,
            Message = $"Job instance {i.Id} - Agent: {i.AgentId ?? "N/A"}"
        }).ToList();
    }

    private async Task SaveJob()
    {
        if (Job == null) return;

        try
        {
            await JobService.UpdateJobAsync(Job);
            
            // Update job group assignment
            var groupIds = selectedJobGroupId.HasValue 
                ? new[] { selectedJobGroupId.Value } 
                : Array.Empty<int>();
            await JobGroupService.UpdateJobGroupAssignmentsAsync(JobId, groupIds);
            
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Job saved successfully.");
            await OnJobSaved.InvokeAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save job: {ex.Message}");
        }
    }

    private async Task DeleteJob()
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to delete this job? This action cannot be undone.",
            "Confirm Delete",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            try
            {
                await JobService.DeleteJobAsync(JobId);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Job deleted successfully.");
                await OnJobDeleted.InvokeAsync();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to delete job: {ex.Message}");
            }
        }
    }

    private async Task OnCloseClick()
    {
        await OnClose.InvokeAsync();
    }

    private async Task OpenAddScheduleDialog()
    {
        var newSchedule = new JobSchedule
        {
            JobId = JobId,
            Enabled = true,
            Monday = true,
            Tuesday = true,
            Wednesday = true,
            Thursday = true,
            Friday = true
        };

        await OpenScheduleDialog(newSchedule, "Add New Job Schedule");
    }

    private async Task OpenEditScheduleDialog(JobSchedule schedule)
    {
        await OpenScheduleDialog(schedule, $"Edit Job Schedule - {schedule.ScheduleName}");
    }

    private async Task OpenScheduleDialog(JobSchedule schedule, string title)
    {
        var result = await DialogService.OpenAsync<EditJobScheduleDialog>(title,
            new Dictionary<string, object>
            {
                { "Schedule", schedule },
                { "OnScheduleSaved", EventCallback.Factory.Create<JobSchedule>(this, OnScheduleSaved) },
                { "OnScheduleDeleted", EventCallback.Factory.Create<int>(this, OnScheduleDeleted) },
                { "OnCancel", EventCallback.Factory.Create(this, () => DialogService.Close()) }
            },
            new DialogOptions { Width = "700px", CloseDialogOnEsc = true });
    }

    private async Task OnScheduleSaved(JobSchedule schedule)
    {
        try
        {
            if (schedule.Id == 0)
            {
                await JobService.CreateJobScheduleAsync(schedule);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Schedule created successfully.");
            }
            else
            {
                await JobService.UpdateJobScheduleAsync(schedule);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Schedule updated successfully.");
            }

            DialogService.Close();
            Schedules = await JobService.GetJobSchedulesAsync(JobId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save schedule: {ex.Message}");
        }
    }

    private async Task OnScheduleDeleted(int scheduleId)
    {
        try
        {
            await JobService.DeleteJobScheduleAsync(scheduleId);
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Schedule deleted successfully.");
            DialogService.Close();
            Schedules = await JobService.GetJobSchedulesAsync(JobId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to delete schedule: {ex.Message}");
        }
    }

    private async Task OpenAddParameterDialog()
    {
        var newParameter = new JobDatum { JobId = JobId };
        await OpenParameterDialog(newParameter, "Add New Parameter");
    }

    private async Task OpenEditParameterDialog(JobDatum parameter)
    {
        await OpenParameterDialog(parameter, $"Edit Parameter - {parameter.JobFieldDescription}");
    }

    private async Task OpenParameterDialog(JobDatum parameter, string title)
    {
        var result = await DialogService.OpenAsync<AddParameterDialog>(title,
            new Dictionary<string, object>
            {
                { "Parameter", parameter },
                { "OnParameterSaved", EventCallback.Factory.Create<JobDatum>(this, OnParameterSaved) },
                { "OnCancel", EventCallback.Factory.Create(this, () => DialogService.Close()) }
            },
            new DialogOptions { Width = "550px", CloseDialogOnEsc = true });
    }

    private async Task OnParameterSaved(JobDatum parameter)
    {
        try
        {
            if (parameter.Id == 0)
            {
                await JobService.CreateJobParameterAsync(parameter);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Parameter created successfully.");
            }
            else
            {
                await JobService.UpdateJobParameterAsync(parameter);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Parameter updated successfully.");
            }

            DialogService.Close();
            Parameters = await JobService.GetJobParametersAsync(JobId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save parameter: {ex.Message}");
        }
    }

    private async Task DeleteParameter(int parameterId)
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to delete this parameter?",
            "Confirm Delete",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            try
            {
                await JobService.DeleteJobParameterAsync(parameterId);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Parameter deleted successfully.");
                Parameters = await JobService.GetJobParametersAsync(JobId);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to delete parameter: {ex.Message}");
            }
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        SelectedFile = e.File;
        StateHasChanged();
    }

    private async Task UploadCodeFile()
    {
        if (SelectedFile == null || Job == null) return;

        IsUploading = true;
        StateHasChanged();

        try
        {
            // For now, just update the file name - actual file storage would integrate with Azure Blob Storage
            Job.JobCodeFile = $"{Job.JobName} ({DateTime.Now:yyyy-MM-dd_HH-mm-ss}).{Path.GetExtension(SelectedFile.Name).TrimStart('.')}";
            await JobService.UpdateJobAsync(Job);
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Code file uploaded successfully.");
            SelectedFile = null;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to upload file: {ex.Message}");
        }
        finally
        {
            IsUploading = false;
            StateHasChanged();
        }
    }

    private BadgeStyle GetLogLevelStyle(string level)
    {
        return level switch
        {
            "Error" => BadgeStyle.Danger,
            "Warning" => BadgeStyle.Warning,
            "Info" => BadgeStyle.Info,
            "Success" => BadgeStyle.Success,
            _ => BadgeStyle.Light
        };
    }

    private class LogEntry
    {
        public int Id { get; set; }
        public string Level { get; set; } = string.Empty;
        public DateTime CreatedDate { get; set; }
        public string Message { get; set; } = string.Empty;
    }
}
