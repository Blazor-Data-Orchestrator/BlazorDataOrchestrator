@using BlazorOrchestrator.Web.Data
@using BlazorOrchestrator.Web.Data.Data
@using BlazorOrchestrator.Web.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@inject WizardStateService WizardState
@inject IServiceProvider ServiceProvider

<RadzenDialog />
<RadzenNotification />
<RadzenTooltip />
<RadzenContextMenu />

<div class="rz-p-4" style="min-height: calc(100vh - 120px); background-color: #f4f6f8;">
    <RadzenCard Class="rz-mb-4 rz-shadow-3">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
                <RadzenIcon Icon="build" IconColor="@Colors.Primary" />
                <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H1" Class="rz-m-0">
                    <strong>BlazorOrchestrator</strong> <span style="font-weight: 300;">Installation Wizard</span>
                </RadzenText>
            </div>
            <div class="d-flex align-items-center gap-3">
                <RadzenText TextStyle="TextStyle.Body2" Class="rz-m-0">Step @CurrentStep of 4</RadzenText>
                <RadzenProgressBar Value="@(CurrentStep * 25)" ShowValue="false" Style="width: 100px; height: 8px;" />
            </div>
        </div>
    </RadzenCard>

    <RadzenCard Class="rz-p-5 rz-shadow-5" Style="min-height: 500px; display: flex; flex-direction: column;">
        <div style="flex: 1;">
            <RadzenText TextStyle="TextStyle.H4" Class="rz-mb-4">@GetCurrentStepTitle()</RadzenText>
            @if (CurrentStep == 1)
            {
                <StepAdmin Model="@Model" />
            }
            else if (CurrentStep == 2)
            {
                <StepDatabase Model="@Model" />
            }
            else if (CurrentStep == 3)
            {
                <StepStorage Model="@Model" />
            }
            else if (CurrentStep == 4)
            {
                <StepSummary Model="@Model" OnInstallComplete="OnInstallComplete" />
            }
        </div>
        <div class="d-flex justify-content-between rz-mt-5 rz-pt-3" style="border-top: 1px solid #e0e0e0;">
            <RadzenButton Variant="Variant.Text" Click="PrevStep" Text="Back" Disabled="@(CurrentStep == 1 || IsLoading)" ButtonStyle="ButtonStyle.Light" />
            <RadzenButton Click="NextStep" Text="@(CurrentStep == 4 ? "Install System" : "Next Step")" Icon="@(CurrentStep == 4 ? "save" : "arrow_forward")" IsBusy="@IsLoading" BusyText="Processing..." ButtonStyle="@(CurrentStep == 4 ? ButtonStyle.Success : ButtonStyle.Primary)" />
        </div>
    </RadzenCard>
</div>

@code {
    [Parameter]
    public string WizardMode { get; set; } = "INSTALL";

    [Parameter]
    public EventCallback OnInstallComplete { get; set; }

    public int CurrentStep { get; set; } = 1;
    public int StepIndex { get; set; } = 0;
    public bool IsLoading { get; set; } = false;
    public InstallationModel Model { get; set; } = new InstallationModel();

    public class WizardStep { public int Id { get; set; } public string Label { get; set; } = string.Empty; public string Icon { get; set; } = string.Empty; }

    public List<WizardStep> Steps = new List<WizardStep> {
        new WizardStep { Id = 1, Label = "Admin Account", Icon = "account_circle" },
        new WizardStep { Id = 2, Label = "Database", Icon = "dns" },
        new WizardStep { Id = 3, Label = "Storage", Icon = "storage" },
        new WizardStep { Id = 4, Label = "Installation", Icon = "verified" }
    };

    protected override void OnParametersSet()
    {
        // If we're in CreateAdministrator mode, start at step 1 (admin)
        // If we're in RUNSCRIPTS mode, we might skip to a specific step
        if (WizardMode == "CreateAdministrator")
        {
            CurrentStep = 1;
        }
    }

    protected override void OnInitialized()
    {
        // Sync with the WizardStateService
        WizardState.SetInstalling(true);
        WizardState.SetStep(CurrentStep);
    }

    private string GetStepClass(int stepId)
    {
        if (CurrentStep == stepId) return "rz-background-color-primary-light rz-color-primary";
        if (CurrentStep > stepId) return "rz-color-success";
        return "rz-color-base-400";
    }

    private string GetCurrentStepTitle() => CurrentStep switch
    {
        1 => "Setup Administrator",
        2 => "Connect Database",
        3 => "Configure Storage",
        4 => "Review & Install",
        _ => string.Empty
    };

    private async Task NextStep()
    {
        IsLoading = true;
        await Task.Delay(500); // Simulate processing

        if (CurrentStep < 4)
        {
            CurrentStep++;
            StepIndex++;
            WizardState.SetStep(CurrentStep);
        }
        else
        {
            // Final installation step - trigger the install
            await PerformInstallation();
        }

        IsLoading = false;
    }

    private void PrevStep()
    {
        if (CurrentStep > 1)
        {
            CurrentStep--;
            StepIndex--;
            WizardState.SetStep(CurrentStep);
        }
    }

    private async Task PerformInstallation()
    {
        try
        {
            using var scope = ServiceProvider.CreateScope();
            var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();

            // Create admin user if it doesn't exist
            var existingUser = await context.AspNetUsers
                .FirstOrDefaultAsync(u => u.UserName == Model.AdminUser || u.Email == Model.AdminEmail);

            if (existingUser == null)
            {
                // Create a simple password hash (in production, use proper Identity hashing)
                var passwordHasher = new PasswordHasher<AspNetUser>();
                var newUser = new AspNetUser
                {
                    Id = Guid.NewGuid().ToString(),
                    UserName = Model.AdminUser,
                    NormalizedUserName = Model.AdminUser?.ToUpperInvariant(),
                    Email = Model.AdminEmail,
                    NormalizedEmail = Model.AdminEmail?.ToUpperInvariant(),
                    EmailConfirmed = true,
                    SecurityStamp = Guid.NewGuid().ToString(),
                    ConcurrencyStamp = Guid.NewGuid().ToString(),
                    PhoneNumberConfirmed = false,
                    TwoFactorEnabled = false,
                    LockoutEnabled = false,
                    AccessFailedCount = 0
                };
                newUser.PasswordHash = passwordHasher.HashPassword(newUser, Model.AdminPassword ?? "Admin@123");

                context.AspNetUsers.Add(newUser);
                await context.SaveChangesAsync();
            }

            // Notify parent that installation is complete
            if (OnInstallComplete.HasDelegate)
            {
                await OnInstallComplete.InvokeAsync();
            }
        }
        catch (Exception ex)
        {
            // Log or display error
            Console.WriteLine($"Installation error: {ex.Message}");
        }
    }
}
