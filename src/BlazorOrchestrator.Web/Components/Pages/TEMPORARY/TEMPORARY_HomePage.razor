@page "/temporary"
@using Radzen
@using Radzen.Blazor
@using BlazorOrchestrator.Web.Services
@using BlazorOrchestrator.Web.Data.Data
@using BlazorOrchestrator.Web.Components.Pages.Dialogs
@using BlazorDataOrchestrator.Core
@inject ProjectCreatorService ProjectCreatorService
@inject JobService JobService
@inject JobGroupService JobGroupService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject NavigationManager NavigationManager
@inject JobManager JobManager
@inject TimeDisplayService TimeDisplayService

<PageTitle>Dashboard</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
        <RadzenIcon Icon="assignment" Style="font-size: 1.5rem;" />
        <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1" Style="margin: 0;">Status of all running jobs</RadzenText>
    </RadzenStack>

    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.SpaceBetween" Wrap="FlexWrap.Wrap">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
            <RadzenButton Text="Create Visual Studio Project" ButtonStyle="ButtonStyle.Success" Click="@OpenCreateProjectDialog" />
            <RadzenButton Text="Create New Job" ButtonStyle="ButtonStyle.Primary" Click="@OpenCreateJobDialog" />
            <RadzenButton Text="Refresh" ButtonStyle="ButtonStyle.Light" Icon="refresh" Click="@LoadJobsAsync" Disabled="@isLoading" />
        </RadzenStack>

    </RadzenStack>

    <RadzenCard Style="padding: 1rem;">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem" Wrap="FlexWrap.Wrap">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="filter_list" Style="color: #6b7280;" />
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; color: #6b7280;">Filter by Job Group:</RadzenText>
            </RadzenStack>
            <RadzenDropDown @bind-Value="@selectedJobGroupId" Data="@JobGroupFilterOptions"
                            TextProperty="Text" ValueProperty="Value"
                            Style="min-width: 200px;" Placeholder="All Job Groups"
                            Change="@OnJobGroupFilterChanged" AllowClear="true" />
            @if (selectedJobGroupId.HasValue)
            {
                <RadzenButton Text="Clear Filter" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small"
                              Icon="clear" Click="@ClearJobGroupFilter" />
            }
        </RadzenStack>
    </RadzenCard>

    @if (isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 200px;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Medium" />
            <RadzenText TextStyle="TextStyle.Body1" Style="color: #6b7280;">Loading jobs...</RadzenText>
        </RadzenStack>
    }
    else if (!Jobs.Any())
    {
        <RadzenCard Style="padding: 2rem; text-align: center;">
            <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                <RadzenIcon Icon="folder_off" Style="font-size: 3rem; color: #9ca3af;" />
                <RadzenText TextStyle="TextStyle.H6" Style="color: #6b7280; margin: 0;">No jobs found</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="color: #9ca3af; margin: 0;">Create your first job to get started</RadzenText>
                <RadzenButton Text="Create New Job" ButtonStyle="ButtonStyle.Primary" Click="@OpenCreateJobDialog" />
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <RadzenRow Gap="1rem">
            @foreach (var job in Jobs)
            {
                <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                    <RadzenCard Style="padding: 1.5rem;">
                        <RadzenStack Gap="1rem">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenText TextStyle="TextStyle.H6" TagName="TagName.H3" Style="margin: 0; font-weight: 600;">@job.Name</RadzenText>
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem">
                                    <span style="@GetStatusDotStyle(job)"></span>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="@GetStatusTextStyle(job)">
                                        @GetStatusText(job)
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>

                            @if (job.JobGroups.Any())
                            {
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem" Wrap="FlexWrap.Wrap" AlignItems="AlignItems.Center">
                                    <RadzenIcon Icon="folder" Style="font-size: 0.875rem; color: #6b7280;" />
                                    @foreach (var groupName in job.JobGroups)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@groupName" Style="font-size: 0.75rem;" />
                                    }
                                </RadzenStack>
                            }

                            <RadzenStack Orientation="Orientation.Horizontal" Gap="2rem">
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280; margin: 0;">Last run</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@job.LastRun</RadzenText>
                                </RadzenStack>
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280; margin: 0;">Next run</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@job.NextRun</RadzenText>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap" AlignItems="AlignItems.Center">
                                <RadzenButton Text="Edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Click="@(() => OpenJobDetailsDialog(job.Id))" />
                                <RadzenButton Text="Schedule" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" />
                                @if (job.IsRunning)
                                {
                                    <RadzenButton Text="Stop" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Outlined" Size="ButtonSize.Small" />
                                    <RadzenButton Text="Logs" ButtonStyle="ButtonStyle.Info" Variant="Variant.Outlined" Size="ButtonSize.Small" Style="color: #6b7280;" Click="@(() => OpenLogsDialog(job.Id, job.Name))" />
                                }
                                else if (job.IsEnabled)
                                {
                                    <RadzenButton Text="Run Now" ButtonStyle="ButtonStyle.Base" Variant="Variant.Outlined" Size="ButtonSize.Small" Click="@(() => RunJobNow(job))" />
                                    <RadzenButton Text="Logs" ButtonStyle="ButtonStyle.Info" Variant="Variant.Outlined" Size="ButtonSize.Small" Style="color: #6b7280;" Click="@(() => OpenLogsDialog(job.Id, job.Name))" />
                                }
                                else
                                {
                                    <RadzenButton Text="Enable" ButtonStyle="ButtonStyle.Light" Variant="Variant.Outlined" Size="ButtonSize.Small" />
                                    <RadzenButton Text="Logs" ButtonStyle="ButtonStyle.Info" Variant="Variant.Outlined" Size="ButtonSize.Small" Style="color: #6b7280;" Click="@(() => OpenLogsDialog(job.Id, job.Name))" />
                                }
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
            }
        </RadzenRow>
    }
</RadzenStack>

@code {
    private List<JobViewModel> Jobs { get; set; } = new();
    private List<JobViewModel> AllJobs { get; set; } = new();
    private List<JobGroup> JobGroups { get; set; } = new();
    private List<FilterOption> JobGroupFilterOptions { get; set; } = new();
    private int? selectedJobGroupId = null;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadJobGroupsAsync();
        await LoadJobsAsync();
    }

    private async Task LoadJobGroupsAsync()
    {
        try
        {
            JobGroups = await JobGroupService.GetActiveJobGroupsAsync();
            JobGroupFilterOptions = JobGroups.Select(g => new FilterOption
            {
                Value = g.Id,
                Text = g.JobGroupName ?? "Unnamed Group"
            }).ToList();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load job groups: {ex.Message}");
        }
    }

    private async Task LoadJobsAsync()
    {
        isLoading = true;
        try
        {
            var jobs = await JobService.GetJobsAsync();
            AllJobs = new List<JobViewModel>();

            foreach (var j in jobs)
            {
                var jobGroups = await JobGroupService.GetJobGroupsForJobAsync(j.Id);
                AllJobs.Add(new JobViewModel
                {
                    Id = j.Id,
                    Name = j.JobName ?? "Unnamed Job",
                    IsRunning = j.JobInProcess,
                    IsEnabled = j.JobEnabled,
                    IsQueued = j.JobQueued,
                    HasError = j.JobInError,
                    LastRun = GetLastRunDisplay(j),
                    NextRun = GetNextRunDisplay(j),
                    JobGroups = jobGroups.Select(g => g.JobGroupName ?? "Unnamed").ToList(),
                    JobGroupIds = jobGroups.Select(g => g.Id).ToList()
                });
            }

            ApplyJobGroupFilter();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load jobs: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyJobGroupFilter()
    {
        if (selectedJobGroupId.HasValue)
        {
            Jobs = AllJobs.Where(j => j.JobGroupIds.Contains(selectedJobGroupId.Value)).ToList();
        }
        else
        {
            Jobs = AllJobs.ToList();
        }
    }

    private void OnJobGroupFilterChanged()
    {
        ApplyJobGroupFilter();
    }

    private void ClearJobGroupFilter()
    {
        selectedJobGroupId = null;
        ApplyJobGroupFilter();
    }

    private string GetLastRunDisplay(Job job)
    {
        var lastRun = job.JobSchedules?
            .Where(s => s.LastRun.HasValue)
            .OrderByDescending(s => s.LastRun)
            .FirstOrDefault()?.LastRun;

        if (!lastRun.HasValue)
            return "Never";

        var now = DateTime.UtcNow;
        var diff = now - lastRun.Value;

        if (diff.TotalMinutes < 1)
            return "Just now";
        if (diff.TotalHours < 1)
            return $"{(int)diff.TotalMinutes}m ago";
        if (lastRun.Value.Date == now.Date)
            return $"Today {lastRun.Value:HH:mm}";
        if (lastRun.Value.Date == now.Date.AddDays(-1))
            return $"Yesterday {lastRun.Value:HH:mm}";

        return lastRun.Value.ToString("MMM d, HH:mm");
    }

    private string GetNextRunDisplay(Job job)
    {
        var enabledSchedule = job.JobSchedules?
            .FirstOrDefault(s => s.Enabled);

        if (enabledSchedule == null)
            return "Not scheduled";

        // Calculate next run based on schedule settings
        if (enabledSchedule.RunEveryHour.HasValue && enabledSchedule.RunEveryHour > 0)
        {
            var lastRun = enabledSchedule.LastRun ?? DateTime.UtcNow;
            var nextRun = lastRun.AddHours(enabledSchedule.RunEveryHour.Value);

            var now = DateTime.UtcNow;
            if (nextRun.Date == now.Date)
                return $"Today {nextRun:HH:mm}";
            if (nextRun.Date == now.Date.AddDays(1))
                return $"Tomorrow {nextRun:HH:mm}";

            return nextRun.ToString("MMM d, HH:mm");
        }

        return "See schedule";
    }

    private string GetStatusDotStyle(JobViewModel job)
    {
        var color = job.HasError ? "#ef4444" : // Red for error
                    job.IsRunning ? "#22c55e" : // Green for running
                    job.IsQueued ? "#f59e0b" :  // Amber for queued
                    job.IsEnabled ? "#3b82f6" : // Blue for enabled but not running
                    "#6b7280";                  // Gray for disabled

        return $"width: 8px; height: 8px; border-radius: 50%; background-color: {color};";
    }

    private string GetStatusTextStyle(JobViewModel job)
    {
        var color = job.HasError ? "#ef4444" :
                    job.IsRunning ? "#22c55e" :
                    job.IsQueued ? "#f59e0b" :
                    job.IsEnabled ? "#3b82f6" :
                    "#6b7280";

        return $"color: {color}; margin: 0;";
    }

    private string GetStatusText(JobViewModel job)
    {
        if (job.HasError) return "Error";
        if (job.IsRunning) return "Running";
        if (job.IsQueued) return "Queued";
        if (job.IsEnabled) return "Ready";
        return "Disabled";
    }

    private class JobViewModel
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public bool IsRunning { get; set; }
        public bool IsEnabled { get; set; }
        public bool IsQueued { get; set; }
        public bool HasError { get; set; }
        public string LastRun { get; set; } = string.Empty;
        public string NextRun { get; set; } = string.Empty;
        public List<string> JobGroups { get; set; } = new();
        public List<int> JobGroupIds { get; set; } = new();
    }

    private class FilterOption
    {
        public int Value { get; set; }
        public string Text { get; set; } = string.Empty;
    }

    // Create Job Dialog state
    private string newJobName = string.Empty;

    private async Task OpenJobDetailsDialog(int jobId)
    {
        var job = AllJobs.FirstOrDefault(j => j.Id == jobId);
        var title = job != null ? $"Edit Job - {job.Name}" : "Edit Job";

        await DialogService.OpenAsync<JobDetailsDialog>(title,
            new Dictionary<string, object>
            {
                { "JobId", jobId },
                { "OnClose", EventCallback.Factory.Create(this, () => DialogService.Close()) },
                { "OnJobDeleted", EventCallback.Factory.Create(this, async () =>
                    {
                        DialogService.Close();
                        await LoadJobsAsync();
                    }) },
                { "OnJobSaved", EventCallback.Factory.Create(this, async () =>
                    {
                        await LoadJobsAsync();
                    }) }
            },
            new DialogOptions { Width = "950px", CloseDialogOnEsc = false, CloseDialogOnOverlayClick = false });
    }

    private async Task OpenLogsDialog(int jobId, string jobName)
    {
        var allLogs = new List<LogDisplayEntry>();

        // Load job instances as log entries
        var instances = await JobService.GetJobInstancesAsync(jobId);
        var instanceLogs = instances.Select(i => new LogDisplayEntry
        {
            Id = i.Id,
            JobInstanceId = i.Id,
            Level = i.HasError ? "Error" : (i.InProcess ? "Info" : "Success"),
            CreatedDate = i.CreatedDate,
            Message = $"Job instance {i.Id} - Agent: {i.AgentId ?? "N/A"}",
            Source = "Instance"
        });
        allLogs.AddRange(instanceLogs);

        // Also load logs from Azure Table Storage (JobLogs table)
        try
        {
            var azureLogs = await JobManager.GetAllLogsForJobAsync(jobId);
            var tableLogEntries = azureLogs.Select(l => new LogDisplayEntry
            {
                Id = 0,
                JobInstanceId = l.JobInstanceId,
                Level = l.Level ?? "Info",
                CreatedDate = l.Timestamp,
                Message = $"[{l.Action}] {l.Details}",
                Source = "AzureTable"
            });
            allLogs.AddRange(tableLogEntries);
        }
        catch
        {
            // If Azure Table logs fail, still show instance logs
        }

        // Sort all logs by date descending
        var logs = allLogs.OrderByDescending(l => l.CreatedDate).ToList();

        await DialogService.OpenAsync($"Logs - {jobName}", ds =>
            @<RadzenStack Gap="1rem" Style="min-width: 600px; max-height: 500px;">
        @if (!logs.Any())
        {
                <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="padding: 2rem;">
                    <RadzenIcon Icon="info" Style="font-size: 2rem; color: #6b7280;" />
                    <RadzenText TextStyle="TextStyle.Body1" Style="color: #6b7280;">No logs available for this job.</RadzenText>
                </RadzenStack>
        }
        else
        {
                <RadzenDataGrid Data="@logs" TItem="LogDisplayEntry"
                                AllowPaging="true" PageSize="10" PagerHorizontalAlign="HorizontalAlign.Center"
                                AllowSorting="true" Style="height: auto;" Density="Density.Compact">
                    <Columns>
                        <RadzenDataGridColumn TItem="LogDisplayEntry" Property="Level" Title="Level" Width="100px">
                            <Template Context="log">
                                <RadzenBadge BadgeStyle="@GetLogBadgeStyle(log.Level)" Text="@log.Level" />
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="LogDisplayEntry" Property="CreatedDate" Title="Created Date" Width="150px">
                            <Template Context="log">
                                @TimeDisplayService.FormatDateTime(log.CreatedDate)
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="LogDisplayEntry" Property="Message" Title="Message" />
                    </Columns>
                </RadzenDataGrid>
        }
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" Style="margin-top: 0.5rem;">
                <RadzenButton Text="Refresh" Icon="refresh" ButtonStyle="ButtonStyle.Secondary" Size="ButtonSize.Small" Click="@(async () => { ds.Close(); await OpenLogsDialog(jobId, jobName); })" />
                <RadzenButton Text="Close" ButtonStyle="ButtonStyle.Light" Click="@(() => ds.Close())" />
            </RadzenStack>
        </RadzenStack>,
        new DialogOptions { Width = "850px", CloseDialogOnEsc = true, CloseDialogOnOverlayClick = true });
    }

    private BadgeStyle GetLogBadgeStyle(string level)
    {
        return level switch
        {
            "Error" => BadgeStyle.Danger,
            "Warning" => BadgeStyle.Warning,
            "Info" => BadgeStyle.Info,
            "Success" => BadgeStyle.Success,
            _ => BadgeStyle.Light
        };
    }

    private class LogDisplayEntry
    {
        public int Id { get; set; }
        public int JobInstanceId { get; set; }
        public string Level { get; set; } = string.Empty;
        public DateTime CreatedDate { get; set; }
        public string Message { get; set; } = string.Empty;
        public string Source { get; set; } = string.Empty; // "Instance" or "AzureTable"
    }

    private async Task OpenCreateJobDialog()
    {
        newJobName = string.Empty;

        var result = await DialogService.OpenAsync<CreateJobDialog>("Create New Job",
            new Dictionary<string, object>
            {
                { "JobName", newJobName },
                { "AvailableJobGroups", JobGroups },
                { "OnJobCreatedWithGroups", EventCallback.Factory.Create<(string JobName, IEnumerable<int> JobGroupIds)>(this, OnJobCreatedWithGroups) },
                { "OnCancel", EventCallback.Factory.Create(this, () => DialogService.Close()) }
            },
            new DialogOptions { Width = "500px", CloseDialogOnEsc = true });
    }

    private async Task OnJobCreatedWithGroups((string JobName, IEnumerable<int> JobGroupIds) data)
    {
        try
        {
            // Get default organization (or first available)
            var org = await JobService.GetDefaultOrganizationAsync();
            if (org == null)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "No organization found. Please create an organization first.");
                return;
            }

            var job = await JobService.CreateJobAsync(data.JobName, org.Id);

            // Assign job to selected groups
            if (data.JobGroupIds.Any())
            {
                await JobGroupService.UpdateJobGroupAssignmentsAsync(job.Id, data.JobGroupIds);
            }

            DialogService.Close();
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"Job '{data.JobName}' created successfully.");

            // Open the job details dialog
            await OpenJobDetailsDialog(job.Id);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to create job: {ex.Message}");
        }
    }

    // Keep for backward compatibility
    private async Task OnJobCreated(string jobName)
    {
        try
        {
            // Get default organization (or first available)
            var org = await JobService.GetDefaultOrganizationAsync();
            if (org == null)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "No organization found. Please create an organization first.");
                return;
            }

            var job = await JobService.CreateJobAsync(jobName, org.Id);
            DialogService.Close();
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"Job '{jobName}' created successfully.");

            // Open the job details dialog
            await OpenJobDetailsDialog(job.Id);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to create job: {ex.Message}");
        }
    }

    // Dialog state
    private string projectName = string.Empty;
    private string validationError = string.Empty;
    private bool isCreating = false;
    private bool IsValid => string.IsNullOrEmpty(validationError) && !string.IsNullOrWhiteSpace(projectName);

    private async Task OpenCreateProjectDialog()
    {
        projectName = string.Empty;
        validationError = string.Empty;
        isCreating = false;

        var result = await DialogService.OpenAsync("Create New Project", ds =>
            @<RadzenStack Gap="1rem" Style="min-width: 350px;">
            <RadzenStack Gap="0.25rem">
                <RadzenLabel Text="Enter project name" Component="ProjectName" />
                <RadzenTextBox Value="@projectName" Name="ProjectName" Style="width: 100%;"
                               Placeholder="e.g., MyNewProject"
                               Change="@(args => OnProjectNameChange(args, ds))" />
                @if (!string.IsNullOrEmpty(validationError))
                {
                    <RadzenText TextStyle="TextStyle.Caption" Style="color: #ef4444; margin: 0;">@validationError</RadzenText>
                }
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End" Style="margin-top: 1rem;">
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Variant="Variant.Outlined"
                              Click="@(() => ds.Close(false))" />
                <RadzenButton Text="Create" ButtonStyle="ButtonStyle.Primary"
                              Click="@(() => OnCreateClick(ds))" />
            </RadzenStack>
        @if (isCreating)
        {
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" Style="margin: 0 auto;" />
        }
        </RadzenStack>,
        new DialogOptions { ShowTitle = true, CloseDialogOnEsc = true, CloseDialogOnOverlayClick = false }
        );
    }

    private void OnProjectNameChange(string value, DialogService ds)
    {
        projectName = value ?? string.Empty;
        ValidateProjectName();
        ds.Refresh();
    }

    private void ValidateProjectName()
    {
        if (string.IsNullOrWhiteSpace(projectName))
        {
            validationError = "Project name is required.";
        }
        else if (projectName.Length > 20)
        {
            validationError = "Project name must be 20 characters or less.";
        }
        else if (projectName.Contains(' '))
        {
            validationError = "Project name cannot contain spaces.";
        }
        else
        {
            validationError = string.Empty;
        }
    }

    private async Task OnCreateClick(DialogService ds)
    {
        ValidateProjectName();
        if (!IsValid) return;

        isCreating = true;
        ds.Refresh();

        try
        {
            var result = await ProjectCreatorService.CreateProjectAsync(projectName);
            if (result.Success)
            {
                ds.Close(true);
                await ShowSuccessDialog(projectName, result.OutputPath!);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to create project: {ex.Message}");
        }
        finally
        {
            isCreating = false;
            ds.Refresh();
        }
    }

    private async Task ShowSuccessDialog(string name, string outputPath)
    {
        await DialogService.OpenAsync("Project Created Successfully", ds =>
            @<RadzenStack Gap="1.5rem" Style="min-width: 450px; text-align: center; padding: 1rem;">
            <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="check_circle" Style="font-size: 3rem; color: #22c55e;" />
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Your project '@name' has been created!</RadzenText>
            </RadzenStack>

            <RadzenStack Gap="1rem" Style="text-align: left; background-color: #f8fafc; padding: 1rem; border-radius: 8px;">
                <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 600;">How to open your new project:</RadzenText>
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;"><strong>1.</strong> Open Visual Studio</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;"><strong>2.</strong> Select <em>File → Open → Project/Solution</em></RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;"><strong>3.</strong> Navigate to:</RadzenText>
                    <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; padding: 0.5rem; background-color: #e2e8f0; border-radius: 4px; font-family: monospace; word-break: break-all;">@outputPath</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;"><strong>4.</strong> Open the <code>.csproj</code> or <code>.sln</code> file</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;"><strong>5.</strong> Press <strong>F5</strong> to build and run</RadzenText>
                </RadzenStack>
            </RadzenStack>

            <RadzenButton Text="OK" ButtonStyle="ButtonStyle.Primary" Click="@(() => ds.Close())" Style="min-width: 100px;" />
        </RadzenStack>,
        new DialogOptions { ShowTitle = true, CloseDialogOnEsc = true, CloseDialogOnOverlayClick = true }
        );
    }

    private async Task RunJobNow(JobViewModel job)
    {
        // Get the actual job from the database to check if it has code file
        var fullJob = await JobService.GetJobByIdAsync(job.Id);
        if (fullJob == null)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Job not found.");
            return;
        }

        // Check if job has a code file uploaded
        if (string.IsNullOrEmpty(fullJob.JobCodeFile))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Please upload a NuGet package before running the job.");
            return;
        }

        try
        {
            // Create JobInstance and send to queue via JobManager
            var jobInstanceId = await JobManager.RunJobNowAsync(job.Id);

            NotificationService.Notify(NotificationSeverity.Success, "Job Queued",
                $"Job '{job.Name}' has been queued for execution. Instance ID: {jobInstanceId}");

            // Refresh job list to show updated status
            await LoadJobsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to run job: {ex.Message}");
        }
    }
}
