@page "/temporary"
@using Radzen
@using Radzen.Blazor
@using BlazorOrchestrator.Web.Services
@using BlazorOrchestrator.Web.Data.Data
@using BlazorOrchestrator.Web.Components.Pages.Dialogs
@inject ProjectCreatorService ProjectCreatorService
@inject JobService JobService
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject NavigationManager NavigationManager

<PageTitle>Dashboard</PageTitle>

<RadzenStack Gap="1.5rem">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
        <RadzenIcon Icon="assignment" Style="font-size: 1.5rem;" />
        <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1" Style="margin: 0;">Status of all running jobs</RadzenText>
    </RadzenStack>

    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
        <RadzenButton Text="Create Visual Studio Project" ButtonStyle="ButtonStyle.Success" Click="@OpenCreateProjectDialog" />
        <RadzenButton Text="Create New Job" ButtonStyle="ButtonStyle.Primary" Click="@OpenCreateJobDialog" />
        <RadzenButton Text="Refresh" ButtonStyle="ButtonStyle.Light" Icon="refresh" Click="@LoadJobsAsync" Disabled="@isLoading" />
    </RadzenStack>

    @if (isLoading)
    {
        <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="min-height: 200px;">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Medium" />
            <RadzenText TextStyle="TextStyle.Body1" Style="color: #6b7280;">Loading jobs...</RadzenText>
        </RadzenStack>
    }
    else if (!Jobs.Any())
    {
        <RadzenCard Style="padding: 2rem; text-align: center;">
            <RadzenStack AlignItems="AlignItems.Center" Gap="1rem">
                <RadzenIcon Icon="folder_off" Style="font-size: 3rem; color: #9ca3af;" />
                <RadzenText TextStyle="TextStyle.H6" Style="color: #6b7280; margin: 0;">No jobs found</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" Style="color: #9ca3af; margin: 0;">Create your first job to get started</RadzenText>
                <RadzenButton Text="Create New Job" ButtonStyle="ButtonStyle.Primary" Click="@OpenCreateJobDialog" />
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
    <RadzenRow Gap="1rem">
        @foreach (var job in Jobs)
        {
            <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                <RadzenCard Style="padding: 1.5rem;">
                    <RadzenStack Gap="1rem">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                            <RadzenText TextStyle="TextStyle.H6" TagName="TagName.H3" Style="margin: 0; font-weight: 600;">@job.Name</RadzenText>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem">
                                <span style="@GetStatusDotStyle(job)"></span>
                                <RadzenText TextStyle="TextStyle.Body2" Style="@GetStatusTextStyle(job)">
                                    @GetStatusText(job)
                                </RadzenText>
                            </RadzenStack>
                        </RadzenStack>

                        <RadzenStack Orientation="Orientation.Horizontal" Gap="2rem">
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280; margin: 0;">Last run</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@job.LastRun</RadzenText>
                            </RadzenStack>
                            <RadzenStack Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Caption" Style="color: #6b7280; margin: 0;">Next run</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;">@job.NextRun</RadzenText>
                            </RadzenStack>
                        </RadzenStack>

                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap" AlignItems="AlignItems.Center">
                            <RadzenButton Text="Edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Click="@(() => NavigationManager.NavigateTo($"/job/{job.Id}"))" />
                            <RadzenButton Text="Schedule" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" />
                            @if (job.IsRunning)
                            {
                                <RadzenButton Text="Stop" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Outlined" Size="ButtonSize.Small" />
                                <RadzenButton Text="Logs" ButtonStyle="ButtonStyle.Base" Variant="Variant.Text" Size="ButtonSize.Small" Style="color: #6b7280;" />
                            }
                            else if (job.IsEnabled)
                            {
                                <RadzenButton Text="Run Now" ButtonStyle="ButtonStyle.Base" Variant="Variant.Outlined" Size="ButtonSize.Small" />
                                <RadzenButton Text="Logs" ButtonStyle="ButtonStyle.Base" Variant="Variant.Text" Size="ButtonSize.Small" Style="color: #6b7280;" />
                            }
                            else
                            {
                                <RadzenButton Text="Enable" ButtonStyle="ButtonStyle.Light" Variant="Variant.Outlined" Size="ButtonSize.Small" />
                                <RadzenButton Text="Logs" ButtonStyle="ButtonStyle.Base" Variant="Variant.Text" Size="ButtonSize.Small" Style="color: #6b7280;" />
                            }
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        }
    </RadzenRow>
    }
</RadzenStack>

@code {
    private List<JobViewModel> Jobs { get; set; } = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadJobsAsync();
    }

    private async Task LoadJobsAsync()
    {
        isLoading = true;
        try
        {
            var jobs = await JobService.GetJobsAsync();
            Jobs = jobs.Select(j => new JobViewModel
            {
                Id = j.Id,
                Name = j.JobName ?? "Unnamed Job",
                IsRunning = j.JobInProcess,
                IsEnabled = j.JobEnabled,
                IsQueued = j.JobQueued,
                HasError = j.JobInError,
                LastRun = GetLastRunDisplay(j),
                NextRun = GetNextRunDisplay(j)
            }).ToList();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load jobs: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetLastRunDisplay(Job job)
    {
        var lastRun = job.JobSchedules?
            .Where(s => s.LastRun.HasValue)
            .OrderByDescending(s => s.LastRun)
            .FirstOrDefault()?.LastRun;

        if (!lastRun.HasValue)
            return "Never";

        var now = DateTime.UtcNow;
        var diff = now - lastRun.Value;

        if (diff.TotalMinutes < 1)
            return "Just now";
        if (diff.TotalHours < 1)
            return $"{(int)diff.TotalMinutes}m ago";
        if (lastRun.Value.Date == now.Date)
            return $"Today {lastRun.Value:HH:mm}";
        if (lastRun.Value.Date == now.Date.AddDays(-1))
            return $"Yesterday {lastRun.Value:HH:mm}";
        
        return lastRun.Value.ToString("MMM d, HH:mm");
    }

    private string GetNextRunDisplay(Job job)
    {
        var enabledSchedule = job.JobSchedules?
            .FirstOrDefault(s => s.Enabled);

        if (enabledSchedule == null)
            return "Not scheduled";

        // Calculate next run based on schedule settings
        if (enabledSchedule.RunEveryHour.HasValue && enabledSchedule.RunEveryHour > 0)
        {
            var lastRun = enabledSchedule.LastRun ?? DateTime.UtcNow;
            var nextRun = lastRun.AddHours(enabledSchedule.RunEveryHour.Value);
            
            var now = DateTime.UtcNow;
            if (nextRun.Date == now.Date)
                return $"Today {nextRun:HH:mm}";
            if (nextRun.Date == now.Date.AddDays(1))
                return $"Tomorrow {nextRun:HH:mm}";
            
            return nextRun.ToString("MMM d, HH:mm");
        }

        return "See schedule";
    }

    private string GetStatusDotStyle(JobViewModel job)
    {
        var color = job.HasError ? "#ef4444" : // Red for error
                    job.IsRunning ? "#22c55e" : // Green for running
                    job.IsQueued ? "#f59e0b" :  // Amber for queued
                    job.IsEnabled ? "#3b82f6" : // Blue for enabled but not running
                    "#6b7280";                  // Gray for disabled
        
        return $"width: 8px; height: 8px; border-radius: 50%; background-color: {color};";
    }

    private string GetStatusTextStyle(JobViewModel job)
    {
        var color = job.HasError ? "#ef4444" :
                    job.IsRunning ? "#22c55e" :
                    job.IsQueued ? "#f59e0b" :
                    job.IsEnabled ? "#3b82f6" :
                    "#6b7280";
        
        return $"color: {color}; margin: 0;";
    }

    private string GetStatusText(JobViewModel job)
    {
        if (job.HasError) return "Error";
        if (job.IsRunning) return "Running";
        if (job.IsQueued) return "Queued";
        if (job.IsEnabled) return "Ready";
        return "Disabled";
    }

    private class JobViewModel
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public bool IsRunning { get; set; }
        public bool IsEnabled { get; set; }
        public bool IsQueued { get; set; }
        public bool HasError { get; set; }
        public string LastRun { get; set; } = string.Empty;
        public string NextRun { get; set; } = string.Empty;
    }

    // Create Job Dialog state
    private string newJobName = string.Empty;

    private async Task OpenCreateJobDialog()
    {
        newJobName = string.Empty;

        var result = await DialogService.OpenAsync<CreateJobDialog>("Create New Job",
            new Dictionary<string, object>
            {
                { "JobName", newJobName },
                { "OnJobCreated", EventCallback.Factory.Create<string>(this, OnJobCreated) },
                { "OnCancel", EventCallback.Factory.Create(this, () => DialogService.Close()) }
            },
            new DialogOptions { Width = "450px", CloseDialogOnEsc = true });
    }

    private async Task OnJobCreated(string jobName)
    {
        try
        {
            // Get default organization (or first available)
            var org = await JobService.GetDefaultOrganizationAsync();
            if (org == null)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "No organization found. Please create an organization first.");
                return;
            }

            var job = await JobService.CreateJobAsync(jobName, org.Id);
            DialogService.Close();
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"Job '{jobName}' created successfully.");

            // Navigate to the job details page
            NavigationManager.NavigateTo($"/job/{job.Id}");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to create job: {ex.Message}");
        }
    }

    // Dialog state
    private string projectName = string.Empty;
    private string validationError = string.Empty;
    private bool isCreating = false;
    private bool IsValid => string.IsNullOrEmpty(validationError) && !string.IsNullOrWhiteSpace(projectName);

    private async Task OpenCreateProjectDialog()
    {
        projectName = string.Empty;
        validationError = string.Empty;
        isCreating = false;

        var result = await DialogService.OpenAsync("Create New Project", ds =>
            @<RadzenStack Gap="1rem" Style="min-width: 350px;">
            <RadzenStack Gap="0.25rem">
                <RadzenLabel Text="Enter project name" Component="ProjectName" />
                <RadzenTextBox Value="@projectName" Name="ProjectName" Style="width: 100%;"
                               Placeholder="e.g., MyNewProject"
                               Change="@(args => OnProjectNameChange(args, ds))" />
                @if (!string.IsNullOrEmpty(validationError))
                {
                    <RadzenText TextStyle="TextStyle.Caption" Style="color: #ef4444; margin: 0;">@validationError</RadzenText>
                }
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End" Style="margin-top: 1rem;">
                <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Variant="Variant.Outlined"
                              Click="@(() => ds.Close(false))" />
                <RadzenButton Text="Create" ButtonStyle="ButtonStyle.Primary"
                              Click="@(() => OnCreateClick(ds))" />
            </RadzenStack>
        @if (isCreating)
        {
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" Style="margin: 0 auto;" />
        }
        </RadzenStack>,
        new DialogOptions { ShowTitle = true, CloseDialogOnEsc = true, CloseDialogOnOverlayClick = false }
        );
    }

    private void OnProjectNameChange(string value, DialogService ds)
    {
        projectName = value ?? string.Empty;
        ValidateProjectName();
        ds.Refresh();
    }

    private void ValidateProjectName()
    {
        if (string.IsNullOrWhiteSpace(projectName))
        {
            validationError = "Project name is required.";
        }
        else if (projectName.Length > 20)
        {
            validationError = "Project name must be 20 characters or less.";
        }
        else if (projectName.Contains(' '))
        {
            validationError = "Project name cannot contain spaces.";
        }
        else
        {
            validationError = string.Empty;
        }
    }

    private async Task OnCreateClick(DialogService ds)
    {
        ValidateProjectName();
        if (!IsValid) return;

        isCreating = true;
        ds.Refresh();

        try
        {
            var result = await ProjectCreatorService.CreateProjectAsync(projectName);
            if (result.Success)
            {
                ds.Close(true);
                await ShowSuccessDialog(projectName, result.OutputPath!);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to create project: {ex.Message}");
        }
        finally
        {
            isCreating = false;
            ds.Refresh();
        }
    }

    private async Task ShowSuccessDialog(string name, string outputPath)
    {
        await DialogService.OpenAsync("Project Created Successfully", ds =>
            @<RadzenStack Gap="1.5rem" Style="min-width: 450px; text-align: center; padding: 1rem;">
            <RadzenStack AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="check_circle" Style="font-size: 3rem; color: #22c55e;" />
                <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Your project '@name' has been created!</RadzenText>
            </RadzenStack>

            <RadzenStack Gap="1rem" Style="text-align: left; background-color: #f8fafc; padding: 1rem; border-radius: 8px;">
                <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin: 0; font-weight: 600;">How to open your new project:</RadzenText>
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;"><strong>1.</strong> Open Visual Studio</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;"><strong>2.</strong> Select <em>File → Open → Project/Solution</em></RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;"><strong>3.</strong> Navigate to:</RadzenText>
                    <RadzenText TextStyle="TextStyle.Caption" Style="margin: 0; padding: 0.5rem; background-color: #e2e8f0; border-radius: 4px; font-family: monospace; word-break: break-all;">@outputPath</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;"><strong>4.</strong> Open the <code>.csproj</code> or <code>.sln</code> file</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0;"><strong>5.</strong> Press <strong>F5</strong> to build and run</RadzenText>
                </RadzenStack>
            </RadzenStack>

            <RadzenButton Text="OK" ButtonStyle="ButtonStyle.Primary" Click="@(() => ds.Close())" Style="min-width: 100px;" />
        </RadzenStack>,
        new DialogOptions { ShowTitle = true, CloseDialogOnEsc = true, CloseDialogOnOverlayClick = true }
        );
    }
}
